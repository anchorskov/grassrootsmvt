<!DOCTYPE html>
<html>
<head>
  <title>Quick API Test</title>
  <script src="/config/environments.js"></script>
  <script src="/src/apiClient.v2.js?v=2025-10-30a"></script>
</head>
<body>
  <!-- Shows current authenticated user (set by authGlobal.js) -->
  <div id="user-email-badge" style="
      position: fixed;
      top: 10px;
      right: 10px;
      background: rgba(37, 99, 235, 0.1);
      color: #1e3a8a;
      font-size: 0.85rem;
      padding: 6px 10px;
      border-radius: 8px;
      border: 1px solid rgba(37, 99, 235, 0.3);
      z-index: 9999;
      font-family: system-ui, sans-serif;
    ">
    üë§ Loading user‚Ä¶
  </div>
  <h1>Quick API Test</h1>
  <div id="results"></div>
  
  <script>
    const results = document.getElementById('results');
    
    function log(message, isError = false) {
      const div = document.createElement('div');
      div.style.margin = '10px 0';
      div.style.padding = '10px';
      div.style.border = '1px solid #ccc';
      div.style.borderRadius = '5px';
      div.style.backgroundColor = isError ? '#fee' : '#efe';
      div.textContent = message;
      results.appendChild(div);
      console.log(message);
    }
    
    async function runTests() {
      try {
        // Wait for environment config to load
        await new Promise(resolve => setTimeout(resolve, 500));
        
        // Test 1: Check if functions are available
        if (typeof window.apiFetch === 'function') {
          log('‚úÖ window.apiFetch is available');
        } else {
          log('‚ùå window.apiFetch is not available', true);
          return;
        }
        
        // Test 2: Check environment config
        if (window.environmentConfig) {
          log('‚úÖ Environment config loaded');
          const pingUrl = window.environmentConfig.getApiUrl('ping');
          log(`‚úÖ Ping URL: ${pingUrl}`);
        } else {
          log('‚ùå Environment config not loaded', true);
        }
        
        // Test 3: Test API ping
        try {
          const response = await window.apiFetch('ping');
          const data = await response.json();
          if (data.ok) {
            log(`‚úÖ API ping successful: ${JSON.stringify(data)}`);
          } else {
            log(`‚ùå API ping failed: ${JSON.stringify(data)}`, true);
          }
        } catch (error) {
          log(`‚ùå API ping error: ${error.message}`, true);
        }
        
        // Test 4: Test call endpoint
        try {
          const response = await window.apiFetch('call', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ require_phone: true })
          });
          const data = await response.json();
          if (data.ok) {
            log(`‚úÖ Call endpoint successful: ${JSON.stringify(data).substring(0, 200)}...`);
          } else {
            log(`‚ö†Ô∏è Call endpoint returned error (expected in test): ${data.error}`, false);
          }
        } catch (error) {
          log(`‚ö†Ô∏è Call endpoint error (expected in test): ${error.message}`, false);
        }
        
      } catch (error) {
        log(`‚ùå Test error: ${error.message}`, true);
      }
    }
    
    // Run tests when page loads
    window.addEventListener('load', runTests);
  </script>
    <!-- Loads global authentication context (window.currentUser) -->
    <script src="../shared/authGlobal.js"></script>
    <script>
      // Update user email badge when window.currentUser is ready
      document.addEventListener("DOMContentLoaded", () => {
        const badge = document.getElementById("user-email-badge");
        const updateBadge = () => {
          if (!badge || !window.currentUser?.loaded) return;
          if (window.currentUser.authenticated) {
            badge.textContent = `üë§ ${window.currentUser.email}`;
          } else {
            badge.textContent = "üîí Not logged in";
          }
        };
        if (window.currentUser?.loaded) {
          updateBadge();
        } else {
          const timer = setInterval(() => {
            if (window.currentUser?.loaded) {
              updateBadge();
              clearInterval(timer);
            }
          }, 200);
        }
      });
    </script>
</body>
</html>
