<!doctype html>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Volunteer Hub</title>
<style>
  body { font-family: system-ui, sans-serif; margin: 1rem; max-width: 900px; }
  .grid { display:grid; grid-template-columns: 1fr 1fr; gap:1rem; }
  .card { border:1px solid #ddd; border-radius:12px; padding:1rem; box-shadow:0 1px 2px rgba(0,0,0,.05); }
  label { display:block; font-weight:600; margin:.5rem 0 .25rem; }
  select, input[type=number] { width:100%; padding:.6rem; border:1px solid #ccc; border-radius:8px; }
  fieldset { border:0; padding:0; margin:.25rem 0 0; }
  .muted { color:#64748b; }
  .row { display:flex; flex-wrap:wrap; gap:.75rem; align-items:center; }
  .row > * { flex: 1 1 180px; }
  button { padding:.6rem 1rem; border-radius:8px; border:0; background:#0ea5e9; color:white; font-weight:600; cursor:pointer; }
  button.secondary { background:#e2e8f0; color:#0f172a; }
  .disabled { opacity:.6; pointer-events:none; }
</style>

<h1>Volunteer Hub</h1>
<p class="muted">Choose a target set, then start <strong>Calls</strong> or <strong>Canvass</strong>. Lists are powered by <code>/meta/wy.json</code> in dev/prod.</p>

<div class="card">
  <div class="grid">
    <div>
      <label for="county">County</label>
      <select id="county"><option value="">— select county —</option></select>
    </div>
    <div>
      <label for="city">City</label>
      <select id="city" disabled><option value="">— select city —</option></select>
    </div>
    <div>
      <label for="district_type">District Type</label>
      <select id="district_type" disabled>
        <option value="">— select type —</option>
        <option value="house">House</option>
        <option value="senate">Senate</option>
      </select>
    </div>
    <div>
      <label for="district">District</label>
      <select id="district" disabled><option value="">— select district —</option></select>
    </div>
  </div>

  <div class="row" style="margin-top:1rem;">
    <div>
      <label>Party</label>
      <fieldset id="parties">
        <label class="row" style="gap:.5rem; align-items:center;">
          <span><input type="checkbox" value="R" checked /> Republican</span>
          <span><input type="checkbox" value="D" checked /> Democratic</span>
          <span><input type="checkbox" value="U" checked /> Unaffiliated/Minor</span>
        </label>
      </fieldset>
    </div>
    <div>
      <label for="count">Number of voters</label>
      <input id="count" type="number" min="1" max="200" value="10" />
    </div>
  </div>

  <div class="row" style="margin-top:1rem;">
    <button id="startCalls" class="disabled" disabled>Start Calls</button>
    <button id="startCanvass" class="secondary disabled" disabled>Start Canvass</button>
    <div id="msg" class="muted"></div>
  </div>
</div>

<script>
const msg = document.getElementById('msg');
const els = {
  county: document.getElementById('county'),
  city: document.getElementById('city'),
  district_type: document.getElementById('district_type'),
  district: document.getElementById('district'),
  count: document.getElementById('count'),
  startCalls: document.getElementById('startCalls'),
  startCanvass: document.getElementById('startCanvass'),
  parties: document.getElementById('parties'),
};

async function loadMeta() {
  msg.textContent = 'Loading metadata…';
  // prefer local static; if missing (first run), try the admin refresh in dev
  let j;
  try {
    const r = await fetch('/meta/wy.json', { cache: 'no-store' });
    if (r.ok) j = await r.json();
  } catch {}
  if (!j) {
    try {
      await fetch('/admin/meta/refresh', { method:'POST' });
      const r2 = await fetch('/meta/wy.json', { cache: 'no-store' });
      if (r2.ok) j = await r2.json();
    } catch {}
  }
  if (!j) {
    msg.textContent = 'Failed to load metadata. Make sure /admin/meta/refresh works in dev.';
    return;
  }
  msg.textContent = '';
  window.__WY_META__ = j;
  fillCounties(j.counties || []);
}

function fillCounties(list) {
  els.county.innerHTML = `<option value="">— select county —</option>` + list.map(c=>`<option>${c}</option>`).join('');
  els.county.disabled = false;
}
function fillCities(county) {
  const cities = (window.__WY_META__?.cities_by_county?.[county]) || [];
  els.city.innerHTML = `<option value="">— select city —</option>` + cities.map(c=>`<option>${c}</option>`).join('');
  els.city.disabled = cities.length === 0;
}
function fillDistricts(county, type) {
  const map = window.__WY_META__?.districts_by_county?.[type] || {};
  const districts = (map[county] || []);
  els.district.innerHTML = `<option value="">— select district —</option>` + districts.map(d=>`<option>${d}</option>`).join('');
  els.district.disabled = districts.length === 0;
}

function updateButtons() {
  const ok = !!els.county.value; // minimal requirement
  [els.startCalls, els.startCanvass].forEach(b=>{
    b.disabled = !ok;
    b.classList.toggle('disabled', !ok);
  });
}

els.county.addEventListener('change', ()=>{
  fillCities(els.county.value);
  els.district_type.disabled = !els.county.value;
  els.district.disabled = true;
  els.district.value = '';
  updateButtons();
});
els.city.addEventListener('change', updateButtons);
els.district_type.addEventListener('change', ()=>{
  const t = els.district_type.value;
  if (t) fillDistricts(els.county.value, t);
  els.district.disabled = !t;
  updateButtons();
});
els.district.addEventListener('change', updateButtons);

function selectedParties() {
  return Array.from(els.parties.querySelectorAll('input[type=checkbox]:checked')).map(x=>x.value);
}

function gatherFilters() {
  const filters = {
    county: els.county.value || null,
    city: els.city.value || null,
    district_type: els.district_type.value || null, // 'house' | 'senate'
    district: els.district.value || null,
    parties: selectedParties(),
    limit: Math.max(1, Math.min(200, Number(els.count.value || 10))),
  };
  return filters;
}

function persistAndNav(target) {
  const filters = gatherFilters();
  sessionStorage.setItem('volunteerFilters', JSON.stringify(filters));
  location.href = target; // e.g. '/index.html' for Calls; '/canvass.html' for Canvass
}

els.startCalls.addEventListener('click', ()=>persistAndNav('/index.html'));
els.startCanvass.addEventListener('click', ()=>persistAndNav('/canvass.html'));

loadMeta();
</script>
