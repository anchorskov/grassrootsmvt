<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta
    http-equiv="Cache-Control"
    content="no-store, no-cache, must-revalidate, max-age=0"
  />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Connecting…</title>
  <style>
    :root {
      --bg: #0b1020;
      --fg: #e8eefc;
      --muted: #9fb0d7;
      --ring: #7aa2ff;
    }
    @media (prefers-color-scheme: light) {
      :root {
        --bg: #f7f9ff;
        --fg: #0c1634;
        --muted: #5f7096;
        --ring: #2956ff;
      }
    }
    * { box-sizing: border-box }
    html, body {
      height: 100%;
      margin: 0;
      background: radial-gradient(1200px 700px at 50% -10%, rgba(122,162,255,.08), transparent),
                  var(--bg);
      color: var(--fg);
      font: 16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
    }
    .wrap {
      min-height: 100%;
      display: grid;
      place-items: center;
      padding: 24px;
    }
    .card {
      width: min(520px, 92vw);
      background: color-mix(in hsl, var(--bg) 90%, #fff 10%);
      border: 1px solid color-mix(in hsl, var(--fg) 10%, transparent);
      border-radius: 18px;
      padding: 28px 24px;
      box-shadow: 0 10px 30px rgba(0,0,0,.18);
      text-align: center;
    }
    .brand {
      font-weight: 650;
      letter-spacing: .2px;
      margin: 0 0 8px;
    }
    .muted { color: var(--muted); margin: 6px 0 0 }
    .spinner {
      width: 44px; height: 44px;
      margin: 6px auto 16px;
      border-radius: 50%;
      border: 4px solid color-mix(in hsl, var(--ring) 35%, transparent);
      border-top-color: var(--ring);
      animation: spin 900ms linear infinite;
    }
    @keyframes spin { to { transform: rotate(1turn) } }
    @media (prefers-reduced-motion: reduce) {
      .spinner { animation: none; border-top-color: color-mix(in hsl, var(--ring) 60%, transparent) }
    }
    .progress {
      display: inline-grid; grid-auto-flow: column; gap: 6px;
      margin: 8px 0 0;
    }
    .dot {
      width: 6px; height: 6px; border-radius: 50%;
      background: var(--muted); opacity: .5;
      animation: pulse 1.4s ease-in-out infinite;
    }
    .dot:nth-child(2){ animation-delay: .15s }
    .dot:nth-child(3){ animation-delay: .3s }
    @keyframes pulse {
      50% { opacity: 1; transform: translateY(-2px) }
    }
    .help {
      margin-top: 14px; font-size: .9rem;
    }
    .link {
      color: var(--fg); text-decoration: underline dotted;
      text-underline-offset: 3px;
    }
    .sr { position: absolute; left: -9999px }
  </style>
</head>
<body>
  <div class="wrap">
    <main class="card" role="status" aria-live="polite" aria-busy="true">
      <div class="spinner" aria-hidden="true"></div>
      <h1 class="brand">Connecting to API…</h1>
      <p class="muted">Verifying your access securely with Cloudflare.</p>
      <div class="progress" aria-hidden="true">
        <span class="dot"></span><span class="dot"></span><span class="dot"></span>
      </div>
      <p class="help muted" id="fallback" hidden>
        Taking longer than expected.
        <a class="link" href="#" id="retry">Try again</a> or
        <a class="link" href="/" id="back">go back</a>.
      </p>
      <span class="sr" id="sr">Connecting. Please wait…</span>
    </main>
  </div>

  <script>
    (async function(){
      // Helper: small sleep
      const wait = (ms)=>new Promise(r=>setTimeout(r,ms));
      const RETRIES = 4;

      // Normalize a team domain string into https://<team>.cloudflareaccess.com
      function normalizeTeamDomain(input){
        if(!input) return null;
        let s = String(input).trim();
        // Accept values like "skovgard.cloudflareaccess.com" or "https://skovgard.cloudflareaccess.com"
        if(!/^https?:\/\//i.test(s)) s = "https://" + s;
        // Strip trailing slash
        s = s.replace(/\/+$/,"");
        return s;
      }

      // Build the Access login URL
      function buildLoginURL(teamDomain, policyAud, returnTo){
        const base = normalizeTeamDomain(teamDomain);
        if(!base) throw new Error("Missing teamDomain");
        if(!policyAud) throw new Error("Missing policyAud");
        const authFinish = "https://api.grassrootsmvt.org/auth/finish?to=" + encodeURIComponent(returnTo);
        // Use the newer path form: /cdn-cgi/access/login/<AUD>
        return `${base}/cdn-cgi/access/login/${policyAud}?redirect_url=${encodeURIComponent(authFinish)}`;
      }

      // Fetch public auth config from the Worker
      async function fetchConfig(){
        const res = await fetch("https://api.grassrootsmvt.org/auth/config", {
          credentials: "omit",
          cache: "no-store",
          referrerPolicy: "no-referrer"
        });
        if(!res.ok){
          throw new Error("config " + res.status);
        }
        return res.json();
      }

      // Expose startAccessLoginRoundTrip for the new script integration
      window.startAccessLoginRoundTrip = async function() {
        // Main: try to get config with a couple of retries (in case Access just updated)
        let config;
        for(let i=0;i<RETRIES;i++){
          try {
            config = await fetchConfig();
            break;
          } catch(err){
            if(i === RETRIES-1) throw err;
            await wait(250 * (i+1));
          }
        }

        const returnUrl = sessionStorage.getItem("access:returnTo") || (location.origin + "/");
        const loginUrl = buildLoginURL(config.teamDomain, config.policyAud, returnUrl);

        // Hand off to Cloudflare Access (top-level navigation = sets cookies correctly)
        location.replace(loginUrl);
      };
    })().catch(err=>{
      console.error("Connecting error", err);
      const fallback = document.getElementById("fallback");
      if (fallback) {
        fallback.hidden = false;
        document.querySelector(".muted").innerHTML = "Could not reach authentication service.";
      }
    });

    // Kick off the Access roundtrip after a tiny paint to avoid layout jump.
    const start = () => {
      try {
        if (window.startAccessLoginRoundTrip) {
          window.startAccessLoginRoundTrip(); // your global from apiClient.js
        } else if (window.Access && typeof window.Access.begin === "function") {
          window.Access.begin();
        } else {
          // Fallback: go back to app which should re-trigger the flow
          location.replace("/");
        }
      } catch (e) {
        showFallback(e);
      }
    };

    // Show a gentle fallback with retry if something goes wrong or it takes too long
    let shown = false;
    const showFallback = (e) => {
      if (shown) return; shown = true;
      const el = document.getElementById("fallback");
      el.hidden = false;
      console.debug("Connecting error:", e);
    };

    // If the network is slow, reveal the fallback affordances after 7s
    const slowTimer = setTimeout(() => showFallback(new Error("slow-connection")), 7000);

    // Wire up retry/back
    document.getElementById("retry")?.addEventListener("click", (ev) => {
      ev.preventDefault();
      shown = false;
      document.getElementById("fallback").hidden = true;
      start();
    });
    document.getElementById("back")?.addEventListener("click", (ev) => {
      ev.preventDefault();
      history.length > 1 ? history.back() : location.replace("/");
    });

    // Give the browser a frame to render before redirecting.
    requestAnimationFrame(() => setTimeout(start, 50));
  </script>
</body>
</html>