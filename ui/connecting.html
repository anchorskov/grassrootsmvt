<!doctype html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Connecting…</title>
<style>
  :root { color-scheme: light dark; }
  body { margin:0; display:grid; place-items:center; min-height:100dvh; font:16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
  .box { text-align:center; padding:2rem; }
  .spin { width:44px; height:44px; border:4px solid transparent; border-top-color: currentColor; border-radius:50%; animation: r .8s linear infinite; margin:0 auto 1rem; }
  @keyframes r { to { transform: rotate(360deg) } }
</style>
<div class="box">
  <div class="spin"></div>
  <h1>Connecting to API…</h1>
  <p>This can take a moment while we verify your Access login.</p>
</div>
<script>
(async () => {
  // 1) Public config (no creds)
  const cfg = await fetch("https://api.grassrootsmvt.org/auth/config", { credentials: "omit" })
    .then(r => r.json());

  // Expected fields from worker: teamDomain (full origin or bare), policyAud
  // Normalize teamDomain to origin
  const team = cfg.teamDomain.replace(/\/+$/, ""); // trim trailing slash
  const policyAud = cfg.policyAud;

  // 2) Where to send the user *back* after Access grants a session:
  //    Access will redirect to worker: /auth/finish?to=<encoded-ui-url>
  const uiTarget = sessionStorage.getItem("access.to") || window.location.origin + "/";
  const finishOnWorker = "https://api.grassrootsmvt.org/auth/finish?to=" + encodeURIComponent(uiTarget);

  // 3) Build Access login URL in the same pattern CF uses in its own 302s:
  //    /cdn-cgi/access/login/<HOSTNAME>?kid=<AUD>&redirect_url=<...>
  const apiHostname = "api.grassrootsmvt.org";
  const loginUrl = `${team}/cdn-cgi/access/login/${apiHostname}` +
                   `?kid=${encodeURIComponent(policyAud)}` +
                   `&redirect_url=${encodeURIComponent(finishOnWorker)}`;

  // Optional: remember where we were before navigating
  sessionStorage.setItem("access.to", uiTarget);

  // Go (top-level navigation avoids CORS and Storage issues)
  window.location.replace(loginUrl);
})();
</script>