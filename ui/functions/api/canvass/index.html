<!doctype html>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="robots" content="noindex, nofollow" />
<title>Canvass Search</title>
<style>
  :root { --bg:#fff; --fg:#0f172a; --muted:#64748b; --border:#e5e7eb; --primary:#0ea5e9; }
  html, body { background:var(--bg); color:var(--fg); }
  body { font-family: system-ui, sans-serif; margin: 1rem; max-width: 720px; }
  h1 { margin: 0 0 .75rem 0; font-size: 1.4rem; display:flex; justify-content:space-between; align-items:center; }
  .toolbar { display:flex; gap:.5rem; align-items:center; flex-wrap:wrap; }
  a.back { text-decoration:none; font-weight:600; color:var(--primary); }
  .card { border: 1px solid var(--border); border-radius: 12px; padding: 1rem; margin: 1rem 0; box-shadow: 0 1px 2px rgba(0,0,0,.04); background:#fff; }
  label { display:block; margin:.5rem 0 .25rem; font-weight:600; }
  input[type=text], select { width: 100%; padding:.6rem; border:1px solid #ccc; border-radius:8px; }
  .row { display:flex; gap:.75rem; flex-wrap: wrap; }
  .row > * { flex:1 1 160px; }
  .muted { color:var(--muted); }
  .error { color:#b91c1c; }
  button { padding:.6rem 1rem; border-radius:8px; border:0; background:var(--primary); color:white; font-weight:600; cursor:pointer; }
  button.secondary { background:#e2e8f0; color:#0f172a; }
  .addr { font-weight:700; }
  .voters { margin:.5rem 0 0 .25rem; }
  .voter { padding:.25rem 0; border-top:1px dashed var(--border); }
  .actions { display:flex; gap:.5rem; flex-wrap:wrap; margin-top:.5rem; }
  .hint { font-size:.9rem; }
</style>

<h1>
  <span>Canvass Search</span>
  <span class="toolbar">
    <a class="back" href="/index.html">← Volunteer Hub</a>
  </span>
</h1>

<div class="card">
  <div class="hint muted" style="margin-bottom:.5rem;">
    Search by <strong>State → County → City/ZIP</strong> and <strong>Street</strong>. Optionally include a house number to sort
    results by nearest house number (works well even without GPS).
  </div>

  <form id="searchForm">
    <div class="row">
      <div>
        <label for="state">State</label>
        <input id="state" name="state" type="text" placeholder="WY" maxlength="2" inputmode="text" autocomplete="address-level1" />
      </div>
      <div>
        <label for="county">County</label>
        <input id="county" name="county" type="text" placeholder="Natrona" autocomplete="address-level2" />
      </div>
    </div>
    <div class="row">
      <div>
        <label for="city">City</label>
        <input id="city" name="city" type="text" placeholder="Casper" autocomplete="address-level2" />
      </div>
      <div>
        <label for="zip">ZIP (optional)</label>
        <input id="zip" name="zip" type="text" placeholder="82601" inputmode="numeric" autocomplete="postal-code" />
      </div>
    </div>
    <div class="row">
      <div>
        <label for="street">Street</label>
        <input id="street" name="street" type="text" placeholder="Main St" required />
      </div>
      <div>
        <label for="house">House # (optional)</label>
        <input id="house" name="house" type="text" placeholder="102" inputmode="numeric" />
      </div>
    </div>

    <div class="row" style="margin-top:.75rem;">
      <button id="searchBtn" type="submit">Search</button>
      <button class="secondary" id="clearBtn" type="button">Clear</button>
    </div>
    <div id="msg" class="muted" style="margin-top:.5rem;"></div>
  </form>
</div>

<div class="card" id="resultsCard" hidden>
  <div class="row" style="justify-content:space-between; align-items:center;">
    <div class="muted" id="summary"></div>
    <button class="secondary" id="exportBtn" type="button" title="Copy JSON of results">Copy JSON</button>
  </div>
  <div id="results"></div>
</div>

<script>
// Same-origin Pages Functions base
window.API = (p) => '/api' + p;

const els = {
  f: document.getElementById('searchForm'),
  msg: document.getElementById('msg'),
  resultsCard: document.getElementById('resultsCard'),
  results: document.getElementById('results'),
  summary: document.getElementById('summary'),
  exportBtn: document.getElementById('exportBtn'),
  state: document.getElementById('state'),
  county: document.getElementById('county'),
  city: document.getElementById('city'),
  zip: document.getElementById('zip'),
  street: document.getElementById('street'),
  house: document.getElementById('house')
};

function setMsg(text, kind="muted") { els.msg.className = kind; els.msg.textContent = text || ""; }

async function jsonFetch(url, init = {}) {
  const r = await fetch(url, {
    credentials: "include",
    ...init,
    headers: { "content-type": "application/json", ...(init.headers || {}) },
  });
  if (!r.ok) throw new Error(`HTTP ${r.status}`);
  const ct = r.headers.get("content-type") || "";
  return ct.includes("application/json") ? r.json() : r.text();
}

function renderResults(payload) {
  const { results = [], query = {} } = payload || {};
  els.resultsCard.hidden = false;
  els.results.innerHTML = "";
  els.summary.textContent = `${results.length} address${results.length===1?"":"es"} for “${[query.house, query.street, query.city, query.state].filter(Boolean).join(", ")}”`;

  results.forEach((g, idx) => {
    const addr = g.address || {};
    const line = [addr.house, addr.street, addr.city, (addr.state||query.state), addr.zip].filter(Boolean).join(", ");
    const qmaps = encodeURIComponent([addr.house, addr.street, addr.city, (addr.state||query.state), addr.zip].filter(Boolean).join(" "));
    const mapUrl = `https://www.google.com/maps/search/?api=1&query=${qmaps}`;

    const card = document.createElement('div');
    card.className = "card";
    card.style.margin = ".75rem 0";
    card.innerHTML = `
      <div class="addr">${line}</div>
      <div class="muted hint">${g.distance_house_numbers != null ? `~${g.distance_house_numbers} house${g.distance_house_numbers===1?"":"s"} from ${query.house || "start"}` : "street match"}</div>
      <div class="voters" id="voters-${idx}"></div>
      <div class="actions">
        <a href="${mapUrl}" target="_blank" rel="noopener">
          <button type="button" class="secondary">Open in Maps</button>
        </a>
        <a href="/index.html?mode=call&house=${encodeURIComponent(addr.house||"")}&street=${encodeURIComponent(addr.street||"")}&city=${encodeURIComponent(addr.city||"")}&state=${encodeURIComponent(addr.state||query.state||"")}&zip=${encodeURIComponent(addr.zip||"")}">
          <button type="button">Start Call Sheet</button>
        </a>
        <a href="/canvass/sheet.html?house=${encodeURIComponent(addr.house||"")}&street=${encodeURIComponent(addr.street||"")}&city=${encodeURIComponent(addr.city||"")}&state=${encodeURIComponent(addr.state||query.state||"")}&zip=${encodeURIComponent(addr.zip||"")}">
          <button type="button">Start Canvass</button>
        </a>
      </div>
    `;

    // voters list
    const vWrap = card.querySelector(`#voters-${idx}`);
    (g.voters || []).forEach(v => {
      const row = document.createElement('div');
      row.className = "voter";
      const phone = v.phone_e164 ? ` • ${v.phone_e164}` : "";
      const party = v.party ? ` • ${v.party}` : "";
      row.textContent = `${v.first_name || ""} ${v.last_name || ""}${party}${phone}`;
      vWrap.appendChild(row);
    });

    els.results.appendChild(card);
  });
}

async function doSearch(e) {
  e && e.preventDefault();
  const payload = {
    state: els.state.value.trim(),
    county: els.county.value.trim(),
    city: els.city.value.trim(),
    zip: els.zip.value.trim(),
    street: els.street.value.trim(),
    house: els.house.value.trim(),
    limit: 100
  };
  if (!payload.street) { setMsg("Please enter a street.", "error"); return; }

  setMsg("Searching…");
  els.resultsCard.hidden = true;
  els.results.innerHTML = "";

  try {
    const data = await jsonFetch(API("/canvass/search"), { method:"POST", body: JSON.stringify(payload) });
    if (!data || data.ok === false) throw new Error(data && data.error ? data.error : "Search failed");
    renderResults(data);
    setMsg("");
    // keep a copy on the element for “Copy JSON”
    els.resultsCard.dataset.json = JSON.stringify(data, null, 2);
  } catch (err) {
    setMsg(`Error: ${err.message}`, "error");
  }
}

// Events
els.f.addEventListener("submit", doSearch);
document.getElementById("clearBtn").addEventListener("click", () => {
  els.f.reset();
  els.resultsCard.hidden = true;
  setMsg("");
});
els.exportBtn.addEventListener("click", () => {
  const text = els.resultsCard.dataset.json || "";
  if (!text) return;
  navigator.clipboard.writeText(text).then(() => setMsg("Copied results JSON to clipboard."), () => setMsg("Copy failed.", "error"));
});

// Convenience: allow Enter in any field to submit
['state','county','city','zip','street','house'].forEach(id => {
  document.getElementById(id).addEventListener('keydown', (e) => {
    if (e.key === 'Enter') { e.preventDefault(); doSearch(e); }
  });
});

// Optional: hydrate from query params (so hub can prefill)
const qp = new URLSearchParams(location.search);
['state','county','city','zip','street','house'].forEach(k => {
  if (qp.has(k)) els[k].value = qp.get(k);
});
if (els.street.value) { doSearch(new Event('submit')); }
</script>
