<!DOCTYPE html>
<html>
<head>
  <title>URL Generation Debug</title>
  <script>
    // Load environment configuration globally
    async function loadEnvironmentConfig() {
      try {
        const module = await import('/config/environments.js');
        window.environmentConfig = module.default || module.environmentConfig;
        console.log('‚úÖ Environment config loaded:', window.environmentConfig);
        console.log('‚úÖ Config object:', window.environmentConfig.config);
        
        // Test URL generation
        console.log('‚úÖ ping URL:', window.environmentConfig.getApiUrl('ping'));
        console.log('‚úÖ call URL:', window.environmentConfig.getApiUrl('call'));
        console.log('‚úÖ whoami URL:', window.environmentConfig.getApiUrl('whoami'));
        
      } catch (error) {
        console.error('‚ùå Environment config error:', error);
        // Show fallback
        console.log('Using fallback configuration');
        window.environmentConfig = {
          shouldBypassAuth: () => location.hostname === 'localhost' || location.hostname === '127.0.0.1',
          getApiUrl: (endpoint, params = {}) => {
            const isLocal = location.hostname === 'localhost' || location.hostname === '127.0.0.1';
            const baseUrl = isLocal ? 'http://localhost:8787' : 'https://api.grassrootsmvt.org';
            
            const endpointMap = {
              'ping': '/api/ping',
              'voters': '/api/voters',
              'call': '/api/call',
              'whoami': '/api/whoami'
            };
            
            const endpointPath = endpointMap[endpoint] || (endpoint.startsWith('/') ? endpoint : `/api/${endpoint}`);
            let url = `${baseUrl}${endpointPath}`;
            
            if (Object.keys(params).length > 0) {
              const searchParams = new URLSearchParams(params);
              url += `?${searchParams.toString()}`;
            }
            return url;
          },
          debug: (message, data) => {
            const isLocal = location.hostname === 'localhost' || location.hostname === '127.0.0.1';
            if (isLocal) console.log(`[ENV-LOCAL] ${message}`, data || '');
          },
          config: {
            environment: location.hostname === 'localhost' ? 'local' : 'production',
            isLocal: location.hostname === 'localhost' || location.hostname === '127.0.0.1'
          }
        };
        
        console.log('‚úÖ Fallback ping URL:', window.environmentConfig.getApiUrl('ping'));
        console.log('‚úÖ Fallback call URL:', window.environmentConfig.getApiUrl('call'));
      }
    }
    
    loadEnvironmentConfig();
  </script>
  <script type="module" src="/src/apiClient.js"></script>
</head>
<body>
  <h1>üîç URL Generation Debug</h1>
  
  <button onclick="testApiFetch()">Test apiFetch</button>
  <button onclick="testAPI()">Test API function</button>
  
  <div id="results" style="margin-top: 1rem; padding: 1rem; background: #f5f5f5; border-radius: 8px;"></div>

  <script>
    const results = document.getElementById('results');
    
    function log(message) {
      results.innerHTML += '<div>' + message + '</div>';
      console.log(message);
    }
    
    async function testApiFetch() {
      results.innerHTML = '<h3>Testing apiFetch:</h3>';
      
      try {
        await new Promise(resolve => setTimeout(resolve, 500)); // Wait for loading
        
        if (typeof window.apiFetch !== 'function') {
          log('‚ùå window.apiFetch not available');
          return;
        }
        
        log('‚úÖ window.apiFetch is available');
        
        // Test the URL generation without actually calling it
        log('üîç Testing environment config in apiFetch context...');
        
        if (window.environmentConfig) {
          log('‚úÖ Environment config available in browser');
          log('üîó ping URL: ' + window.environmentConfig.getApiUrl('ping'));
          log('üîó call URL: ' + window.environmentConfig.getApiUrl('call'));
        } else {
          log('‚ùå Environment config not available');
        }
        
        // Now test actual apiFetch
        log('üöÄ Calling apiFetch("ping")...');
        try {
          const response = await window.apiFetch('ping');
          log('‚úÖ apiFetch ping response status: ' + response.status);
          log('‚úÖ apiFetch ping URL used: ' + response.url);
        } catch (error) {
          log('‚ùå apiFetch ping error: ' + error.message);
        }
        
      } catch (error) {
        log('‚ùå Test error: ' + error.message);
      }
    }
    
    function testAPI() {
      results.innerHTML = '<h3>Testing API function:</h3>';
      
      // Simulate the API function from call.html
      const API = (path) => {
        if (window.environmentConfig) {
          const cleanPath = path.replace(/^\/?(api\/)?/, '');
          return window.environmentConfig.getApiUrl(cleanPath);
        }
        const isLocal = location.hostname === 'localhost' || location.hostname === '127.0.0.1';
        const baseUrl = isLocal ? 'http://localhost:8787' : 'https://api.grassrootsmvt.org';
        const cleanPath = path.replace(/^\/?(api\/)?/, '');
        return `${baseUrl}/api/${cleanPath}`;
      };
      
      log('‚úÖ Testing API function:');
      log('üîó API("/whoami"): ' + API('/whoami'));
      log('üîó API("/call"): ' + API('/call'));
      log('üîó API("ping"): ' + API('ping'));
      log('üîó API("/api/ping"): ' + API('/api/ping'));
    }
  </script>
</body>
</html>