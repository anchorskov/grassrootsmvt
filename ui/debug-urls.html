<!DOCTYPE html>
<html>
<head>
  <title>URL Generation Debug</title>
  <script src="/config/environments.js"></script>
  <script src="/src/apiClient.v2.js?v=2025-10-30a"></script>
</head>
<body>
  <h1>🔍 URL Generation Debug</h1>
  
  <button onclick="testApiFetch()">Test apiFetch</button>
  <button onclick="testAPI()">Test API function</button>
  
  <div id="results" style="margin-top: 1rem; padding: 1rem; background: #f5f5f5; border-radius: 8px;"></div>

  <script>
    const results = document.getElementById('results');
    
    function log(message) {
      results.innerHTML += '<div>' + message + '</div>';
      console.log(message);
    }
    
    async function testApiFetch() {
      results.innerHTML = '<h3>Testing apiFetch:</h3>';
      
      try {
        await new Promise(resolve => setTimeout(resolve, 500)); // Wait for loading
        
        if (typeof window.apiFetch !== 'function') {
          log('❌ window.apiFetch not available');
          return;
        }
        
        log('✅ window.apiFetch is available');
        
        // Test the URL generation without actually calling it
        log('🔍 Testing environment config in apiFetch context...');
        
        if (window.environmentConfig) {
          log('✅ Environment config available in browser');
          log('🔗 ping URL: ' + window.environmentConfig.getApiUrl('ping'));
          log('🔗 call URL: ' + window.environmentConfig.getApiUrl('call'));
        } else {
          log('❌ Environment config not available');
        }
        
        // Now test actual apiFetch
        log('🚀 Calling apiFetch("ping")...');
        try {
          const response = await window.apiFetch('ping');
          log('✅ apiFetch ping response status: ' + response.status);
          log('✅ apiFetch ping URL used: ' + response.url);
        } catch (error) {
          log('❌ apiFetch ping error: ' + error.message);
        }
        
      } catch (error) {
        log('❌ Test error: ' + error.message);
      }
    }
    
    function testAPI() {
      results.innerHTML = '<h3>Testing API function:</h3>';
      
      // Simulate the API function from call.html
      const API = (path) => {
        if (!window.environmentConfig) return `/api/${path.replace(/^\/?(api\/)?/, '')}`;
        const cleanPath = path.replace(/^\/?(api\/)?/, '');
        return window.environmentConfig.getApiUrl(cleanPath);
      };
      
      log('✅ Testing API function:');
      log('🔗 API("/whoami"): ' + API('/whoami'));
      log('🔗 API("/call"): ' + API('/call'));
      log('🔗 API("ping"): ' + API('ping'));
      log('🔗 API("/api/ping"): ' + API('/api/ping'));
    }
  </script>
    <!-- Loads global authentication context (window.currentUser) -->
    <script src="../shared/authGlobal.js"></script>
</body>
</html>
