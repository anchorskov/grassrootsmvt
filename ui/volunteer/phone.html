<!doctype html>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Phone Banking</title>
<style>
  body{font-family:system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;margin:1rem;max-width:900px}
  .card{border:1px solid #e6e6e6;border-radius:12px;padding:1rem;margin:1rem 0}
  .muted{color:#64748b}
  .row{display:flex;gap:.5rem;flex-wrap:wrap}
  button{padding:.6rem 1rem;border-radius:8px;border:0;background:#0ea5e9;color:#fff;font-weight:600}
  a{color:#0ea5e9}
  .badge{display:inline-block;padding:.25rem .5rem;border-radius:999px;background:#f1f5f9;margin-right:.5rem}
  table{width:100%;border-collapse:collapse;margin-top:.75rem}
  td,th{padding:.5rem;border-bottom:1px solid #eee}
</style>

<h1>Phone Banking</h1>
<div class="card">
  <div id="identity" class="muted">Loading…</div>
  <div id="filters" style="margin-top:.5rem"></div>
  <div style="margin-top:.75rem">
    <button id="getNext">Get Next</button>
    <a href="/" style="margin-left:1rem">Back to landing</a>
  </div>
  <div id="voter" style="margin-top:.75rem"></div>
</div>

<script>
// Simple API helper required by spec
window.API = (p) => 'https://grassrootsmvt-functions.anchorskov.workers.dev/api' + p;

function el(id){return document.getElementById(id)}

async function loadWho(){
  try{
    const r=await fetch(API('/whoami'));
    const j=await r.json();
    el('identity').textContent = 'Signed in as: ' + (j.email||'unknown');
  }catch(e){el('identity').textContent='Unable to load identity';}
}

function renderFilters(f){
  const parts = [f.state||'—', f.county||'—', f.district||'—', f.affiliation||'Any', 'Phone'];
  document.getElementById('filters').innerHTML = parts.map(p=>`<span class="badge">${p}</span>`).join('');
}

function getFilters(){
  try{return JSON.parse(localStorage.getItem('filters')||'{}')||{}}catch(e){return {}}}

document.getElementById('getNext').addEventListener('click', async()=>{
  el('voter').textContent='Loading…';
  try{
    const r=await fetch(API('/call/next'),{method:'POST'});
    const j=await r.json();
    if(!j || !j.voter_id) el('voter').textContent='No voter available';
    else el('voter').innerHTML = `<strong>${j.first_name||'—'} ${j.last_name||''}</strong><br>${j.ra_city||''} ${j.ra_zip||''}<br>Phone: ${j.phone_e164||'—'}`;
  }catch(e){el('voter').textContent='Error: '+e.message}
});

loadWho(); renderFilters(getFilters());
</script>
