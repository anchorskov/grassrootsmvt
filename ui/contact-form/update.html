<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Update Voter Contact - GrassrootsMVT</title>
  <style>
    /* Similar styling to existing forms */
    :root { color-scheme: light dark; }
    body { font-family: system-ui, sans-serif; margin: 1rem; max-width: 800px; }
    .card { border: 1px solid #e5e7eb; border-radius: 12px; padding: 1.5rem; margin: 1rem 0; }
    
    .voter-info-banner {
      background: linear-gradient(135deg, #0ea5e9 0%, #06b6d4 100%);
      color: white;
      padding: 1.5rem;
      border-radius: 12px;
      margin-bottom: 1.5rem;
    }
    .voter-info-banner h2 { margin: 0 0 0.5rem 0; }
    .voter-info-banner p { margin: 0.25rem 0; opacity: 0.9; }
    
    .form-group { margin: 1rem 0; }
    .form-row { display: flex; gap: 1rem; }
    .form-row .form-group { flex: 1; }
    label { display: block; margin-bottom: 0.5rem; font-weight: 600; }
    input, select, textarea { width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; }
    input:disabled { background: #f3f4f6; color: #6b7280; }
    button { padding: 0.75rem 1.5rem; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; }
    .btn-primary { background: #0ea5e9; color: white; }
    .btn-secondary { background: #6b7280; color: white; }
    .btn-success { background: #10b981; color: white; }
    
    .info-box { background: #eff6ff; border: 1px solid #3b82f6; padding: 1rem; border-radius: 8px; margin: 1rem 0; }
    .success-message { background: #dcfce7; border: 1px solid #10b981; padding: 1rem; border-radius: 8px; margin: 1rem 0; display: none; }
    .field-changed { background: #fef3c7; }
    
    .section-header {
      font-size: 1.125rem;
      font-weight: 700;
      margin: 1.5rem 0 1rem 0;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid #e5e7eb;
    }
  </style>
</head>
<body>
  <h1>Update Voter Contact</h1>
  
  <!-- Voter Identity Banner -->
  <div class="voter-info-banner">
    <h2 id="voter-name">Loading...</h2>
    <p id="voter-address"></p>
    <p id="voter-id-display"></p>
  </div>

  <div class="info-box">
    <strong>üìù Update Instructions:</strong> Review and update the voter's contact information below. 
    Fields highlighted in yellow indicate changes from the original registration data.
  </div>

  <form id="update-form">
    <div class="card">
      <!-- Personal Information Section -->
      <div class="section-header">Personal Information</div>
      
      <div class="form-row">
        <div class="form-group">
          <label for="first-name">First Name *</label>
          <input type="text" id="first-name" required>
        </div>
        <div class="form-group">
          <label for="last-name">Last Name *</label>
          <input type="text" id="last-name" required>
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label for="middle-name">Middle Name</label>
          <input type="text" id="middle-name">
        </div>
        <div class="form-group">
          <label for="suffix">Suffix</label>
          <input type="text" id="suffix" placeholder="Jr, Sr, III">
        </div>
      </div>

      <!-- Address Section -->
      <div class="section-header">Address</div>
      
      <div class="form-group">
        <label for="full-address">Full Address *</label>
        <input type="text" id="full-address" required>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label for="city">City</label>
          <input type="text" id="city" disabled>
        </div>
        <div class="form-group">
          <label for="county">County</label>
          <input type="text" id="county" disabled>
        </div>
        <div class="form-group">
          <label for="zip-code">ZIP Code</label>
          <input type="text" id="zip-code" pattern="[0-9]{5}">
        </div>
      </div>

      <!-- Contact Information Section -->
      <div class="section-header">Contact Information</div>
      
      <div class="form-row">
        <div class="form-group">
          <label for="phone-primary">Phone Number</label>
          <input type="tel" id="phone-primary">
        </div>
        <div class="form-group">
          <label for="email">Email Address</label>
          <input type="email" id="email" placeholder="voter@example.com">
        </div>
      </div>

      <!-- Political Information Section -->
      <div class="section-header">Political Information</div>
      
      <div class="form-row">
        <div class="form-group">
          <label for="estimated-party">Estimated Party Affiliation</label>
          <select id="estimated-party">
            <option value="">Unknown</option>
            <option value="Republican">Republican</option>
            <option value="Democrat">Democrat</option>
            <option value="Independent">Independent</option>
            <option value="Libertarian">Libertarian</option>
            <option value="Other">Other</option>
          </select>
        </div>
        <div class="form-group">
          <label for="support-level">Support Level</label>
          <select id="support-level">
            <option value="">Unknown</option>
            <option value="Strong Support">Strong Support</option>
            <option value="Lean Support">Lean Support</option>
            <option value="Undecided">Undecided</option>
            <option value="Lean Against">Lean Against</option>
            <option value="Strong Against">Strong Against</option>
          </select>
        </div>
      </div>

      <!-- Interaction Details Section -->
      <div class="section-header">Interaction Details</div>
      
      <div class="form-group">
        <label for="interaction-type">Type of Contact *</label>
        <select id="interaction-type" required>
          <option value="">Select contact type</option>
          <option value="door-knock">Door Knock</option>
          <option value="phone-call">Phone Call</option>
          <option value="event">Event/Rally</option>
          <option value="volunteer-signup">Volunteer Signup</option>
          <option value="other">Other</option>
        </select>
      </div>
      
      <div class="form-group">
        <label for="notes">Interaction Notes</label>
        <textarea id="notes" rows="4" placeholder="Key points from your conversation..."></textarea>
      </div>
      
      <div class="form-group">
        <label for="tags">Tags (comma-separated)</label>
        <input type="text" id="tags" placeholder="volunteer, donation, yard-sign">
      </div>

      <div class="form-group">
        <label>
          <input type="checkbox" id="needs-followup">
          Needs Follow-up
        </label>
      </div>

      <!-- Action Buttons -->
      <div class="form-row" style="margin-top: 2rem;">
        <button type="button" class="btn-secondary" id="cancel-btn">Cancel</button>
        <button type="submit" class="btn-success">Save Updates</button>
      </div>
    </div>
  </form>

  <div class="success-message" id="success-message">
    <strong>‚úÖ Success!</strong> Voter contact updated successfully.
    <button type="button" class="btn-primary" style="margin-top: 0.5rem;" id="add-another">Add Another Contact</button>
  </div>

  <!-- Hidden fields for tracking -->
  <input type="hidden" id="voter-id">
  <input type="hidden" id="original-data">

  <script src="/src/apiClient.v2.js?v=2025-11-05"></script>
  <script src="/shared/authGlobal.js"></script>
  
  <script type="module">
    const environmentConfig = window.environmentConfig;
    let voterData = {};
    let originalData = {};

    // Get voter data from URL parameters or localStorage
    async function init() {
      const urlParams = new URLSearchParams(window.location.search);
      const voterId = urlParams.get('voter_id');
      const encodedData = urlParams.get('data');
      
      if (encodedData) {
        // Voter data passed via URL
        voterData = JSON.parse(decodeURIComponent(encodedData));
        populateForm(voterData);
      } else if (voterId) {
        // Fetch voter data by ID
        await fetchVoterData(voterId);
      } else {
        // Try to get from sessionStorage (fallback)
        const storedData = sessionStorage.getItem('voterUpdateData');
        if (storedData) {
          voterData = JSON.parse(storedData);
          populateForm(voterData);
          sessionStorage.removeItem('voterUpdateData');
        } else {
          alert('No voter data found. Redirecting to new contact form.');
          window.location.href = '/ui/contact-form/';
        }
      }
      
      setupEventListeners();
    }

    async function fetchVoterData(voterId) {
      try {
        // Fetch voter details from API
        const response = await window.apiPost('canvass/nearby', {
          filters: { voter_id: voterId },
          limit: 1
        });
        
        if (response.ok && response.rows && response.rows.length > 0) {
          voterData = response.rows[0];
          populateForm(voterData);
        } else {
          throw new Error('Voter not found');
        }
      } catch (error) {
        console.error('Failed to fetch voter data:', error);
        alert('Failed to load voter data. Redirecting to new contact form.');
        window.location.href = '/ui/contact-form/';
      }
    }

    function populateForm(voter) {
      // Store original data for change tracking
      originalData = { ...voter };
      document.getElementById('original-data').value = JSON.stringify(originalData);
      
      // Banner information
      const fullName = [voter.first_name || voter.name?.split(' ')[0], voter.last_name || voter.name?.split(' ')[1]].filter(Boolean).join(' ');
      document.getElementById('voter-name').textContent = fullName;
      document.getElementById('voter-address').textContent = `${voter.address}, ${voter.city}, ${voter.zip}`;
      document.getElementById('voter-id-display').textContent = `Voter ID: ${voter.voter_id}`;
      document.getElementById('voter-id').value = voter.voter_id;
      
      // Personal information
      document.getElementById('first-name').value = voter.first_name || voter.name?.split(' ')[0] || '';
      document.getElementById('last-name').value = voter.last_name || voter.name?.split(' ')[1] || '';
      document.getElementById('middle-name').value = voter.middle_name || '';
      document.getElementById('suffix').value = voter.suffix || '';
      
      // Address
      document.getElementById('full-address').value = voter.address || '';
      document.getElementById('city').value = voter.city || '';
      document.getElementById('county').value = voter.county || '';
      document.getElementById('zip-code').value = voter.zip || '';
      
      // Contact information
      document.getElementById('phone-primary').value = voter.phone_e164 || '';
      document.getElementById('email').value = voter.email || '';
      
      // Political information
      document.getElementById('estimated-party').value = voter.party || '';
      document.getElementById('support-level').value = voter.support_level || '';
    }

    function setupEventListeners() {
      // Track changes to highlight modified fields
      document.querySelectorAll('input:not([type="hidden"]), select, textarea').forEach(field => {
        field.addEventListener('input', (e) => {
          const originalValue = originalData[field.id.replace(/-/g, '_')] || '';
          if (e.target.value !== originalValue && e.target.value !== '') {
            e.target.classList.add('field-changed');
          } else {
            e.target.classList.remove('field-changed');
          }
        });
      });

      // Cancel button
      document.getElementById('cancel-btn').addEventListener('click', () => {
        if (confirm('Discard changes and return to contact list?')) {
          window.location.href = '/ui/contact-form/';
        }
      });

      // Form submission
      document.getElementById('update-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        await saveUpdates();
      });

      // Add another contact
      document.getElementById('add-another').addEventListener('click', () => {
        window.location.href = '/ui/contact-form/';
      });
    }

    async function saveUpdates() {
      const voterId = document.getElementById('voter-id').value;
      
      const updatedData = {
        voter_id: voterId,
        first_name: document.getElementById('first-name').value,
        last_name: document.getElementById('last-name').value,
        middle_name: document.getElementById('middle-name').value,
        suffix: document.getElementById('suffix').value,
        address: document.getElementById('full-address').value,
        zip: document.getElementById('zip-code').value,
        phone_primary: document.getElementById('phone-primary').value,
        email: document.getElementById('email').value,
        estimated_party: document.getElementById('estimated-party').value,
        support_level: document.getElementById('support-level').value,
        interaction_type: document.getElementById('interaction-type').value,
        notes: document.getElementById('notes').value,
        tags: document.getElementById('tags').value,
        needs_followup: document.getElementById('needs-followup').checked,
        source: 'contact-update',
        updated_at: new Date().toISOString()
      };

      try {
        // Save to contact API
        const response = await window.apiPost('contact', updatedData);
        
        if (response.ok) {
          console.log('‚úÖ Voter contact updated:', response);
          document.getElementById('update-form').style.display = 'none';
          document.getElementById('success-message').style.display = 'block';
        } else {
          throw new Error(response.error || 'Failed to save updates');
        }
      } catch (error) {
        console.error('‚ùå Failed to save updates:', error);
        alert(`Failed to save updates: ${error.message}`);
      }
    }

    // Initialize on page load
    init();
  </script>
</body>
</html>
