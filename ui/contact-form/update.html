<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Update Voter Contact - GrassrootsMVT</title>
  <style>
    /* Similar styling to existing forms */
    :root { color-scheme: light dark; }
    body { font-family: system-ui, sans-serif; margin: 1rem; max-width: 800px; }
    .card { border: 1px solid #e5e7eb; border-radius: 12px; padding: 1.5rem; margin: 1rem 0; }
    
    .voter-info-banner {
      background: linear-gradient(135deg, #0ea5e9 0%, #06b6d4 100%);
      color: white;
      padding: 1.5rem;
      border-radius: 12px;
      margin-bottom: 1.5rem;
    }
    .voter-info-banner h2 { margin: 0 0 0.5rem 0; }
    .voter-info-banner p { margin: 0.25rem 0; opacity: 0.9; }
    
    .form-group { margin: 1rem 0; }
    .help-text { font-size: 0.9rem; color: #6b7280; margin-top: 0.35rem; }
    .form-row { display: flex; gap: 1rem; }
    .form-row .form-group { flex: 1; }
    label { display: block; margin-bottom: 0.5rem; font-weight: 600; }
    input, select, textarea { width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; }
    input:disabled { background: #f3f4f6; color: #6b7280; }
    button { padding: 0.75rem 1.5rem; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; }
    .btn-primary { background: #0ea5e9; color: white; }
    .btn-secondary { background: #6b7280; color: white; }
    .btn-success { background: #10b981; color: white; }
    
    .info-box { background: #eff6ff; border: 1px solid #3b82f6; padding: 1rem; border-radius: 8px; margin: 1rem 0; }
    .success-message { background: #dcfce7; border: 1px solid #10b981; padding: 1rem; border-radius: 8px; margin: 1rem 0; display: none; }
    .field-changed { background: #fef3c7; }
    
    .section-header {
      font-size: 1.125rem;
      font-weight: 700;
      margin: 1.5rem 0 1rem 0;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid #e5e7eb;
    }
    .pulse-optin-block {
      border: 1px solid #fbbf24;
      background: #fef9c3;
      padding: 1rem;
      border-radius: 8px;
      margin-top: 1rem;
    }
    .pulse-term {
      position: relative;
      cursor: help;
      border-bottom: 1px dotted #b45309;
    }
    .pulse-term::after {
      content: attr(data-tooltip);
      position: absolute;
      left: 0;
      top: calc(100% + 6px);
      min-width: 220px;
      max-width: 280px;
      background: #0f172a;
      color: #f8fafc;
      padding: 0.5rem 0.65rem;
      border-radius: 8px;
      font-size: 0.85rem;
      line-height: 1.3;
      box-shadow: 0 8px 18px rgba(15, 23, 42, 0.35);
      opacity: 0;
      transform: translateY(4px);
      pointer-events: none;
      transition: opacity 0.15s ease, transform 0.15s ease;
      z-index: 10;
    }
    .pulse-term:hover::after,
    .pulse-term:focus-visible::after {
      opacity: 1;
      transform: translateY(0);
    }
    .pulse-optin-label {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      font-weight: 600;
      font-size: 1rem;
    }
    .pulse-optin-checkbox {
      width: 1.2rem;
      height: 1.2rem;
    }
    .error-text { color: #b91c1c; margin-top: 0.25rem; }
    .phone-warning {
      margin-top: 0.35rem;
      font-size: 0.9rem;
      color: #b45309;
    }
  </style>
</head>
<body>
  <h1>Update Voter Contact</h1>
  
  <!-- Voter Identity Banner -->
  <div class="voter-info-banner">
    <h2 id="voter-name">Loading...</h2>
    <p id="voter-address"></p>
    <p id="voter-id-display"></p>
  </div>

  <div class="info-box">
    <strong>üìù Update Instructions:</strong> Review and update the voter's contact information below.
    Fields highlighted in yellow indicate changes from the original registration data. This form does <em>not</em> modify the
    voter file directly ‚Äî every submission lands in our staging queue for review before any official update happens. Thanks
    for capturing accurate notes for the data team!
  </div>

  <form id="update-form">
    <div class="card">
      <!-- Personal Information Section -->
      <div class="section-header">Personal Information</div>
      
      <div class="form-row">
        <div class="form-group">
          <label for="first-name">First Name *</label>
          <input type="text" id="first-name" required>
        </div>
        <div class="form-group">
          <label for="last-name">Last Name *</label>
          <input type="text" id="last-name" required>
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label for="middle-name">Middle Name</label>
          <input type="text" id="middle-name">
        </div>
        <div class="form-group">
          <label for="suffix">Suffix</label>
          <input type="text" id="suffix" placeholder="Jr, Sr, III">
        </div>
      </div>

      <!-- Address Section -->
      <div class="section-header">Address</div>
      
      <div class="form-group">
        <label for="full-address">Full Address *</label>
        <input type="text" id="full-address" required>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label for="city">City</label>
          <input type="text" id="city" disabled>
        </div>
        <div class="form-group">
          <label for="county">County</label>
          <input type="text" id="county" disabled>
        </div>
        <div class="form-group">
          <label for="zip-code">ZIP Code</label>
          <input type="text" id="zip-code" pattern="[0-9]{5}">
        </div>
      </div>

      <!-- Contact Information Section -->
      <div class="section-header">Contact Information</div>
      
      <div class="form-row">
        <div class="form-group">
          <label for="phone-primary">Phone Number</label>
          <input type="tel" id="phone-primary">
          <p class="phone-warning" id="phone-primary-warning" style="display:none;"></p>
        </div>
        <div class="form-group">
          <label for="email">Email Address</label>
          <input type="email" id="email" placeholder="voter@example.com">
        </div>
      </div>

    <div class="form-group pulse-optin-block">
      <label class="pulse-optin-label">
        <input type="checkbox" id="pulse-opt-in" class="pulse-optin-checkbox">
        Opt-in to <span class="pulse-term" tabindex="0" data-tooltip="Pulse is our consented texting list. Only voters who explicitly opt in appear in the Pulse table and can receive SMS reminders.">Pulse text updates</span> (voter permission required)
      </label>
        <p class="help-text">
          Get explicit consent before enabling this. We send occasional reminders (polling place info, early voting, events). Message/data rates may apply. Voters can reply STOP to opt out anytime.
        </p>
      </div>
      <div class="form-group" id="pulse-phone-group" style="display:none;">
        <label for="pulse-phone">Cell number for Pulse texts</label>
        <input type="tel" id="pulse-phone" placeholder="e.g. 307-555-1234">
        <p class="help-text">Use the voter‚Äôs preferred mobile number so we log consent correctly.</p>
        <p class="help-text error-text" id="pulse-phone-error" style="display:none;"></p>
      </div>

      <!-- Political Information Section -->
      <div class="section-header">Political Information</div>
      
      <div class="form-row">
        <div class="form-group">
          <label for="estimated-party">Party Affiliation</label>
          <select id="estimated-party">
            <option value="">Unknown</option>
            <option value="Republican">Republican</option>
            <option value="Democratic">Democratic</option>
            <option value="Unaffiliated">Unaffiliated</option>
            <option value="Libertarian">Libertarian</option>
            <option value="Other">Other</option>
          </select>
        </div>
        <div class="form-group">
          <label for="support-level">Support Level</label>
          <select id="support-level">
            <option value="">Unknown</option>
            <option value="Strong Support">Strong Support</option>
            <option value="Lean Support">Lean Support</option>
            <option value="Undecided">Undecided</option>
            <option value="Lean Against">Lean Against</option>
            <option value="Strong Against">Strong Against</option>
          </select>
        </div>
      </div>

      <!-- Interaction Details Section -->
      <div class="section-header">Interaction Details</div>
      
      <div class="form-group">
        <label for="interaction-type">Type of Contact *</label>
        <select id="interaction-type" required>
          <option value="">Select contact type</option>
          <option value="door-knock">Door Knock</option>
          <option value="phone-call">Phone Call</option>
          <option value="event">Event/Rally</option>
          <option value="volunteer-signup">Volunteer Signup</option>
          <option value="other">Other</option>
        </select>
      </div>
      
      <div class="form-group">
        <label for="notes">Interaction Notes</label>
        <textarea id="notes" rows="4" placeholder="Key points from your conversation..."></textarea>
      </div>
      
      <div class="form-group">
        <label for="tags">Tags (comma-separated)</label>
        <input type="text" id="tags" placeholder="volunteer, donation, yard-sign">
      </div>

      <div class="form-group">
        <label>
          <input type="checkbox" id="needs-followup">
          Needs Follow-up
        </label>
      </div>

      <!-- Action Buttons -->
      <div class="form-row" style="margin-top: 2rem;">
        <button type="button" class="btn-secondary" id="cancel-btn">Discard</button>
        <button type="submit" class="btn-success">Save Updates</button>
      </div>
    </div>
  </form>

  <div class="success-message" id="success-message">
    <strong>‚úÖ Success!</strong> Voter contact updated successfully.
    <button type="button" class="btn-primary" style="margin-top: 0.5rem;" id="add-another">Add Another Contact</button>
  </div>

  <!-- Hidden fields for tracking -->
  <input type="hidden" id="voter-id">
  <input type="hidden" id="original-data">

  <script src="/config/environments.js"></script>
  <script src="/src/apiClient.v2.js?v=2025-11-05"></script>
  <script src="/shared/authGlobal.js"></script>
  
  <script type="module">
    const environmentConfig = window.environmentConfig;
    let voterData = {};
    let originalData = {};
    const RETURN_PATH_KEY = 'contactUpdateReturnTo';
    let returnPath = '/contact-form/';
    const pulseOptInInput = document.getElementById('pulse-opt-in');
    const pulsePhoneGroup = document.getElementById('pulse-phone-group');
    const pulsePhoneInput = document.getElementById('pulse-phone');
    const pulsePhoneError = document.getElementById('pulse-phone-error');
    const phonePrimaryInput = document.getElementById('phone-primary');
    const phonePrimaryWarning = document.getElementById('phone-primary-warning');
    const PREFILLED_FIELDS = new Set([
      'first-name',
      'last-name',
      'middle-name',
      'suffix',
      'full-address',
      'city',
      'county',
      'zip-code',
      'phone-primary',
      'email',
      'pulse-opt-in',
      'pulse-phone',
      'estimated-party',
      'support-level',
    ]);

    const FIELD_EXTRA_KEYS = {
      interaction_type: ['contact_type', 'last_contact_type'],
      notes: ['comments', 'contact_notes', 'last_contact_notes'],
      tags: ['tag_list', 'contact_tags'],
      needs_followup: ['needs_follow_up', 'follow_up_needed', 'followup_required'],
      email: ['email_address', 'preferred_email'],
    };

    function normalizeReturnTarget(target) {
      if (!target) return null;
      const trimmed = target.trim();
      if (!trimmed) return null;
      if (trimmed.startsWith('http')) {
        if (!trimmed.startsWith(window.location.origin)) return null;
        const relative = trimmed.slice(window.location.origin.length) || '/';
        return relative.startsWith('/') ? relative : `/${relative}`;
      }
      return trimmed.startsWith('/') ? trimmed : null;
    }

    function determineReturnPath() {
      const params = new URLSearchParams(window.location.search);
      const fromQuery = normalizeReturnTarget(params.get('return_to'));
      const storedRaw = sessionStorage.getItem(RETURN_PATH_KEY);
      if (storedRaw !== null) {
        sessionStorage.removeItem(RETURN_PATH_KEY);
      }
      
      if (fromQuery) {
        returnPath = fromQuery;
        return;
      }
      
      const stored = normalizeReturnTarget(storedRaw);
      if (stored) {
        returnPath = stored;
        return;
      }
      
      const ref = normalizeReturnTarget(document.referrer || '');
      if (ref) {
        returnPath = ref;
      }
    }

    function navigateBackToOrigin() {
      window.location.href = returnPath || '/contact-form/';
    }

    function togglePulsePhoneGroup(show, { prefill = false } = {}) {
      if (!pulsePhoneGroup) return;
      pulsePhoneGroup.style.display = show ? 'block' : 'none';
      if (show && prefill && pulsePhoneInput) {
        if (!pulsePhoneInput.value) {
          const primary = phonePrimaryInput?.value || voterData?.phone_e164 || '';
          const tenDigit = normalizeTenDigitPhone(primary);
          pulsePhoneInput.value = tenDigit || primary;
        }
      }
      if (!show && pulsePhoneError) {
        pulsePhoneError.style.display = 'none';
        pulsePhoneError.textContent = '';
      }
    }

    function normalizePhoneDigits(value) {
      if (!value) return '';
      return value.replace(/\D/g, '');
    }
    function normalizeTenDigitPhone(value) {
      let digits = normalizePhoneDigits(value);
      if (digits.length === 11 && digits.startsWith('1')) {
        digits = digits.slice(1);
      }
      return digits;
    }

    function toVoterKey(fieldId) {
      if (!fieldId) return '';
      return fieldId.replace(/-/g, '_');
    }

    function resolveVoterValue(voter, key) {
      if (!key) return undefined;
      if (Object.prototype.hasOwnProperty.call(voter, key)) {
        return voter[key];
      }
      const extras = FIELD_EXTRA_KEYS[key] || [];
      for (const alt of extras) {
        if (Object.prototype.hasOwnProperty.call(voter, alt)) {
          return voter[alt];
        }
      }
      return undefined;
    }

    function coerceCheckbox(value) {
      if (typeof value === 'boolean') return value;
      if (typeof value === 'number') return value !== 0;
      if (typeof value === 'string') {
        return ['true', '1', 'yes', 'y'].includes(value.toLowerCase());
      }
      return false;
    }

    function setSelectValue(selectEl, value) {
      if (!selectEl || value === undefined || value === null) return;
      const normalized = String(value);
      selectEl.value = normalized;
      if (selectEl.value !== normalized) {
        const option = document.createElement('option');
        option.value = normalized;
        option.textContent = normalized;
        option.dataset.injected = 'true';
        selectEl.appendChild(option);
        selectEl.value = normalized;
      }
    }

    function applyValueToField(field, value) {
      if (!field || !field.id || value === undefined || value === null || field.id === 'original-data') {
        return false;
      }
      if (field.type === 'checkbox') {
        field.checked = coerceCheckbox(value);
        return true;
      }
      if (field.tagName === 'SELECT') {
        setSelectValue(field, value);
        return true;
      }
      if (Array.isArray(value)) {
        field.value = value.join(', ');
        return true;
      }
      field.value = value;
      return true;
    }

    function autoPopulateFormFields(voter) {
      const fields = document.querySelectorAll('#update-form input:not([type="hidden"]), #update-form select, #update-form textarea');
      fields.forEach(field => {
        if (!field?.id) return;
        if (PREFILLED_FIELDS.has(field.id)) return;
        const key = toVoterKey(field.id);
        const value = resolveVoterValue(voter, key);
        if (value === undefined || value === null || value === '') return;
        applyValueToField(field, value);
      });
    }

    function formatPhoneForDisplay(digits) {
      if (!digits || digits.length !== 10) return digits || '';
      const area = digits.slice(0, 3);
      const prefix = digits.slice(3, 6);
      const line = digits.slice(6);
      return `(${area}) ${prefix}-${line}`;
    }

    function updatePhoneWarning(digits) {
      if (!phonePrimaryWarning) return;
      if (!digits) {
        phonePrimaryWarning.style.display = 'none';
        phonePrimaryWarning.textContent = '';
        return;
      }
      if (digits.length !== 10) {
        phonePrimaryWarning.textContent = 'Enter a complete 10-digit phone number before saving.';
        phonePrimaryWarning.style.display = 'block';
        return;
      }
      if (!digits.startsWith('307')) {
        phonePrimaryWarning.textContent = 'Wyoming numbers typically start with 307 ‚Äî double-check with the voter.';
        phonePrimaryWarning.style.display = 'block';
        return;
      }
      phonePrimaryWarning.style.display = 'none';
      phonePrimaryWarning.textContent = '';
    }

    function setPrimaryPhoneValue(rawValue) {
      if (!phonePrimaryInput) return '';
      const digits = normalizeTenDigitPhone(rawValue);
      const formatted = digits.length === 10 ? formatPhoneForDisplay(digits) : (rawValue || '');
      phonePrimaryInput.value = formatted || '';
      phonePrimaryInput.dataset.rawValue = rawValue || '';
      phonePrimaryInput.title = rawValue ? `Original: ${rawValue}` : '';
      updatePhoneWarning(digits);
      return digits;
    }

    // Get voter data from URL parameters or localStorage
    async function init() {
      determineReturnPath();
      const urlParams = new URLSearchParams(window.location.search);
      const voterId = urlParams.get('voter_id');
      const encodedData = urlParams.get('data');
      
      if (encodedData) {
        // Voter data passed via URL
        voterData = JSON.parse(decodeURIComponent(encodedData));
        populateForm(voterData);
      } else if (voterId) {
        // Fetch voter data by ID
        await fetchVoterData(voterId);
      } else {
        // Try to get from sessionStorage (fallback)
        const storedData = sessionStorage.getItem('voterUpdateData');
        if (storedData) {
          voterData = JSON.parse(storedData);
          populateForm(voterData);
          sessionStorage.removeItem('voterUpdateData');
        } else {
          alert('No voter data found. Redirecting to new contact form.');
          window.location.href = './';
        }
      }
      
      setupEventListeners();
    }

    async function fetchVoterData(voterId) {
      try {
        // Fetch voter details from API
        const response = await window.apiPost('canvass/nearby', {
          filters: { voter_id: voterId },
          limit: 1
        });
        
        if (response.ok && response.rows && response.rows.length > 0) {
          voterData = response.rows[0];
          populateForm(voterData);
        } else {
          throw new Error('Voter not found');
        }
      } catch (error) {
        console.error('Failed to fetch voter data:', error);
        alert('Failed to load voter data. Redirecting to new contact form.');
        window.location.href = './';
      }
    }

    function populateForm(voter) {
      // Store original data for change tracking
      originalData = { ...voter };
      document.getElementById('original-data').value = JSON.stringify(originalData);
      
      // Banner information
      const fullName = [voter.first_name || voter.name?.split(' ')[0], voter.last_name || voter.name?.split(' ')[1]].filter(Boolean).join(' ');
      document.getElementById('voter-name').textContent = fullName;
      document.getElementById('voter-address').textContent = `${voter.address}, ${voter.city}, ${voter.zip}`;
      document.getElementById('voter-id-display').textContent = `Voter ID: ${voter.voter_id}`;
      document.getElementById('voter-id').value = voter.voter_id;
      originalData.pulse_opt_in = false;
      originalData.pulse_phone = pulsePhoneInput?.value || '';
      
      // Personal information
      document.getElementById('first-name').value = voter.first_name || voter.name?.split(' ')[0] || '';
      document.getElementById('last-name').value = voter.last_name || voter.name?.split(' ')[1] || '';
      document.getElementById('middle-name').value = voter.middle_name || '';
      document.getElementById('suffix').value = voter.suffix || '';
      
      // Address
      document.getElementById('full-address').value = voter.address || '';
      document.getElementById('city').value = voter.city || '';
      document.getElementById('county').value = voter.county || '';
      document.getElementById('zip-code').value = voter.zip || '';
      
      // Contact information
      const initialPrimary =
        voter.phone_e164 ||
        voter.phone_primary ||
        voter.phone ||
        '';
      const primaryDigits = setPrimaryPhoneValue(initialPrimary);
      document.getElementById('email').value = voter.email || '';
      if (pulsePhoneInput) {
        const initialPhone =
          voter.phone_e164 ||
          voter.phone_primary ||
          voter.phone ||
          primaryDigits ||
          '';
        const tenDigit = normalizeTenDigitPhone(initialPhone);
        pulsePhoneInput.value = tenDigit || initialPhone;
      }
      if (pulseOptInInput) {
        pulseOptInInput.checked = false;
      }
      togglePulsePhoneGroup(false);
      
      // Political information
      console.log('üé≠ Setting party affiliation:', voter.party);
      const partySelect = document.getElementById('estimated-party');
      if (voter.party) {
        setSelectValue(partySelect, voter.party);
      }
      if (voter.support_level) {
        setSelectValue(document.getElementById('support-level'), voter.support_level);
      } else {
        document.getElementById('support-level').value = '';
      }

      autoPopulateFormFields(voter);
    }

    function setupEventListeners() {
      // Track changes to highlight modified fields
      document.querySelectorAll('input:not([type="hidden"]), select, textarea').forEach(field => {
        const originalKey = field.id.replace(/-/g, '_');
        const getCurrentValue = () => {
          if (field.type === 'checkbox') {
            return field.checked ? '1' : '0';
          }
          return field.value || '';
        };
        const getOriginalValue = () => {
          const raw = originalData[originalKey];
          if (field.type === 'checkbox') {
            return raw ? '1' : '0';
          }
          return raw || '';
        };
        field.addEventListener('input', () => {
          const current = getCurrentValue();
          const original = getOriginalValue();
          if (current !== original && current !== '') {
            field.classList.add('field-changed');
          } else {
            field.classList.remove('field-changed');
          }
        });
      });

      // Cancel button
      document.getElementById('cancel-btn').addEventListener('click', () => {
        if (confirm('Discard changes and return')) {
          navigateBackToOrigin();
        }
      });

      // Form submission
      document.getElementById('update-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        await saveUpdates();
      });

      // Add another contact
      document.getElementById('add-another').addEventListener('click', () => {
        navigateBackToOrigin();
      });

      if (pulseOptInInput) {
        pulseOptInInput.addEventListener('change', () => {
          togglePulsePhoneGroup(pulseOptInInput.checked, { prefill: true });
          if (pulseOptInInput.checked) {
            validatePulsePhone();
          }
        });
      }

      if (phonePrimaryInput) {
        phonePrimaryInput.addEventListener('blur', () => {
          const digits = normalizeTenDigitPhone(phonePrimaryInput.value);
          if (pulsePhoneInput && !pulsePhoneInput.value) {
            pulsePhoneInput.value = digits || phonePrimaryInput.value;
          }
          if (digits.length === 10) {
            phonePrimaryInput.value = formatPhoneForDisplay(digits);
          }
          updatePhoneWarning(digits);
        });
        phonePrimaryInput.addEventListener('input', () => {
          const digits = normalizeTenDigitPhone(phonePrimaryInput.value);
          updatePhoneWarning(digits);
        });
      }
    }

    function validatePulsePhone() {
      if (!pulseOptInInput?.checked) {
        if (pulsePhoneError) {
          pulsePhoneError.style.display = 'none';
          pulsePhoneError.textContent = '';
        }
        return { valid: true, digits: '' };
      }
      const digits = normalizeTenDigitPhone(pulsePhoneInput?.value || '');
      if (digits.length !== 10) {
        if (pulsePhoneError) {
          pulsePhoneError.textContent = 'Enter a 10-digit mobile number before opting in.';
          pulsePhoneError.style.display = 'block';
        }
        pulsePhoneInput?.focus();
        return { valid: false, digits: '' };
      }
      if (pulsePhoneError) {
        pulsePhoneError.style.display = 'none';
        pulsePhoneError.textContent = '';
      }
      return { valid: true, digits };
    }

    async function recordPulseOptIn({ voterId, phoneDigits }) {
      if (!voterId || !phoneDigits) return;
      const e164 = phoneDigits.startsWith('+') ? phoneDigits : `+1${phoneDigits}`;
      try {
        await window.apiPost('pulse', {
          voter_id: voterId,
          contact_method: 'sms',
          consent_source: 'webform',
          phone: e164,
        });
        console.log('üì≤ Pulse opt-in recorded for', voterId);
      } catch (err) {
        console.warn('‚ö†Ô∏è Pulse opt-in recording failed', err);
      }
    }

    async function saveUpdates() {
      const voterId = document.getElementById('voter-id').value;
      const pulseOptInSelected = pulseOptInInput?.checked || false;
      
      const pulseValidation = validatePulsePhone();
      if (!pulseValidation.valid) return;

      const updatedData = {
        voter_id: voterId,
        first_name: document.getElementById('first-name').value,
        last_name: document.getElementById('last-name').value,
        middle_name: document.getElementById('middle-name').value,
        suffix: document.getElementById('suffix').value,
        address: document.getElementById('full-address').value,
        zip: document.getElementById('zip-code').value,
        phone_primary: (() => {
          const digits = normalizeTenDigitPhone(phonePrimaryInput?.value || '');
          if (digits.length === 10) return `+1${digits}`;
          return phonePrimaryInput?.value || '';
        })(),
        email: document.getElementById('email').value,
        estimated_party: document.getElementById('estimated-party').value,
        support_level: document.getElementById('support-level').value,
        interaction_type: document.getElementById('interaction-type').value,
        notes: document.getElementById('notes').value,
        tags: document.getElementById('tags').value,
        needs_followup: document.getElementById('needs-followup').checked,
        source: 'contact-update',
        updated_at: new Date().toISOString()
      };

      const countyValue =
        document.getElementById('county').value ||
        voterData?.county ||
        originalData?.county ||
        '';
      const cityValue =
        document.getElementById('city').value ||
        voterData?.city ||
        originalData?.city ||
        '';

      const firstNameValue =
        updatedData.first_name ||
        voterData?.first_name ||
        voterData?.name?.split(' ')[0] ||
        '';
      const lastNameValue =
        updatedData.last_name ||
        voterData?.last_name ||
        voterData?.name?.split(' ').slice(-1)[0] ||
        '';

      const stagingPayload = {
        voter_id: voterId,
        county: countyValue || 'Unknown',
        city: cityValue || 'Unknown',
        firstName: firstNameValue || 'Unknown',
        lastName: lastNameValue || 'Unknown',
        middleName: updatedData.middle_name,
        suffix: updatedData.suffix,
        address: updatedData.address,
        zip: updatedData.zip,
        contactType: updatedData.interaction_type,
        estimated_party: updatedData.estimated_party,
        support_level: updatedData.support_level,
        phonePrimary: updatedData.phone_primary,
        email: updatedData.email,
        notes: updatedData.notes,
        tags: updatedData.tags,
        needs_followup: updatedData.needs_followup,
        source: updatedData.source,
        updated_at: updatedData.updated_at,
        pulse_opt_in: pulseOptInSelected,
        pulse_phone_digits: pulseValidation.digits || '',
        original_snapshot: originalData,
        form_snapshot: updatedData,
      };

      try {
        const response = await window.apiPost('contact-staging', stagingPayload);

        if (response.ok) {
          console.log('‚úÖ Voter contact staged for review:', response);
          if (pulseOptInSelected && pulseValidation.digits) {
            await recordPulseOptIn({ voterId, phoneDigits: pulseValidation.digits });
          }
          document.getElementById('update-form').style.display = 'none';
          document.getElementById('success-message').style.display = 'block';
        } else {
          throw new Error(response.error || 'Failed to save updates');
        }
      } catch (error) {
        console.error('‚ùå Failed to save updates:', error);
        alert(`Failed to save updates: ${error.message}`);
      }
    }

    // Initialize on page load
    init();
  </script>
  <script type="module">
    import { mountLogoutButton } from '/shared/logoutButton.js';
    import { initSessionTimeout } from '/shared/sessionTimeout.js';

    mountLogoutButton({ position: 'top-right' });
    initSessionTimeout({
      idleMinutes: 20,
      graceMinutes: 10,
    });
  </script>

  <script type="module">
    import { initHelpModal } from '../shared/helpModal.js';
    initHelpModal({
      helpPath: '/help/contact-form-update.md',
      title: 'Update Form Instructions',
      toggleLabel: 'Help',
      position: 'top-right',
    });
  </script>
</body>
</html>
