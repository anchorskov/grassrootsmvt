<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Add New Voter Contact - GrassrootsMVT</title>
  <style>
    /* Similar styling to existing forms */
    :root { color-scheme: light dark; }
    body { font-family: system-ui, sans-serif; margin: 1rem; max-width: 800px; }
    .card { border: 1px solid #e5e7eb; border-radius: 12px; padding: 1.5rem; margin: 1rem 0; }
    .step { display: none; }
    .step.active { display: block; }
    .step-indicator { display: flex; gap: 1rem; margin-bottom: 2rem; }
    .step-indicator .step-dot { width: 2rem; height: 2rem; border-radius: 50%; background: #e5e7eb; display: flex; align-items: center; justify-content: center; font-weight: bold; }
    .step-indicator .step-dot.active { background: #0ea5e9; color: white; }
    .step-indicator .step-dot.completed { background: #10b981; color: white; }
    
    .form-group { margin: 1rem 0; }
    .form-row { display: flex; gap: 1rem; flex-wrap: wrap; }
    .form-row .form-group { flex: 1 1 240px; }
    label { display: block; margin-bottom: 0.5rem; font-weight: 600; }
    input, select, textarea { width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; }
    button { padding: 0.75rem 1.5rem; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; }
    .btn-primary { background: #0ea5e9; color: white; }
    .btn-secondary { background: #6b7280; color: white; }
    .btn-success { background: #10b981; color: white; }
    
    .existing-voter { background: #fef3c7; border: 1px solid #f59e0b; padding: 1rem; border-radius: 6px; margin: 1rem 0; }
    .potential-match { background: #fef2f2; border: 1px solid #ef4444; padding: 0.75rem; border-radius: 6px; margin: 0.5rem 0; }
    .search-results { max-height: 300px; overflow-y: auto; }
    .match-item { padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; margin: 0.5rem 0; cursor: pointer; }
    .match-item:hover { background: #f3f4f6; }
    .match-score { font-size: 0.875rem; color: #6b7280; }
    .lookup-card { background: #f8fafc; border: 1px solid #e5e7eb; border-radius: 12px; padding: 1.5rem; margin: 1rem 0; }
    .lookup-results { margin-top: 1rem; border: 1px solid #e5e7eb; border-radius: 10px; padding: 1rem; background: white; min-height: 60px; }
    .match-actions { display: flex; gap: .5rem; margin-top: .5rem; flex-wrap: wrap; }
    .btn-small { padding: .45rem .85rem; font-size: .85rem; border-radius: 6px; border: none; cursor: pointer; }
    .btn-small.btn-primary { background: #2563eb; color: white; }
    .btn-small.btn-secondary { background: #e2e8f0; color: #0f172a; }
    .pulse-optin-block {
      border: 1px solid #fcd34d;
      background: #fef9c3;
      padding: 1rem;
      border-radius: 8px;
      margin-top: 1rem;
    }
    .pulse-term {
      position: relative;
      cursor: help;
      border-bottom: 1px dotted #b45309;
    }
    .pulse-term::after {
      content: attr(data-tooltip);
      position: absolute;
      left: 0;
      top: calc(100% + 6px);
      min-width: 220px;
      max-width: 280px;
      background: #0f172a;
      color: #f8fafc;
      padding: 0.5rem 0.65rem;
      border-radius: 8px;
      font-size: 0.85rem;
      line-height: 1.3;
      box-shadow: 0 8px 18px rgba(15, 23, 42, 0.35);
      opacity: 0;
      transform: translateY(4px);
      pointer-events: none;
      transition: opacity 0.15s ease, transform 0.15s ease;
      z-index: 10;
    }
    .pulse-term:hover::after,
    .pulse-term:focus-visible::after {
      opacity: 1;
      transform: translateY(0);
    }
    .pulse-optin-label {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      font-weight: 600;
      font-size: 1rem;
    }
    .pulse-optin-checkbox {
      width: 1.2rem;
      height: 1.2rem;
    }
    .error-text { color: #b91c1c; margin-top: 0.25rem; }

    @media (max-width: 640px) {
      .lookup-card, .card {
        padding: 1.25rem;
      }
      .form-row {
        flex-direction: column;
      }
      .form-row .form-group {
        flex: 1 1 100%;
      }
    }
    
    /* Autocomplete styling from canvass form */
    .autocomplete-container { position: relative; }
    .autocomplete-suggestions { 
      position: absolute; 
      top: 100%; 
      left: 0; 
      right: 0; 
      background: white; 
      border: 2px solid #2563eb; 
      border-top: none; 
      border-radius: 0 0 10px 10px; 
      max-height: 200px; 
      overflow-y: auto; 
      z-index: 9999; 
      display: none; 
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    .autocomplete-suggestion { 
      padding: 12px 16px; 
      cursor: pointer; 
      border-bottom: 1px solid #f1f5f9; 
      font-weight: 500;
      background: white;
    }
    .autocomplete-suggestion:hover { background: #f8fafc; border-color: #e2e8f0; }
    .autocomplete-suggestion:last-child { border-bottom: none; }
  </style>
</head>
<body>
  <h1>Add New Voter Contact</h1>
  
  <div class="lookup-card" id="lookup-card">
    <h2>Quick Lookup</h2>
    <p style="margin-top:.25rem;">Start by searching existing records. Choose a match to update, or continue with a new entry.</p>
    <div class="form-row">
      <div class="form-group">
        <label for="lookup-last-name">Last Name</label>
        <input type="text" id="lookup-last-name" placeholder="e.g. WILSON">
      </div>
      <div class="form-group">
        <label for="lookup-first-name">First Name (optional)</label>
        <input type="text" id="lookup-first-name" placeholder="e.g. MIA">
      </div>
    </div>
    <button type="button" class="btn-primary" id="name-search-btn">Search by Name</button>
    <div id="lookup-results" class="lookup-results">
      <em>Enter a last name, then run a search.</em>
    </div>
    <div class="form-row" style="margin-top:1rem;">
      <button type="button" class="btn-primary" id="start-contact-btn">Add New Contact ‚Üì</button>
      <button type="button" class="btn-secondary" id="clear-lookup-btn">Clear Lookup</button>
    </div>
  </div>
  
  <!-- Location -->
  <div class="card" id="section-location">
    <h2>Location</h2>
    <p>Start by selecting the location where you met this voter.</p>
    
    <div class="form-row">
      <div class="form-group">
        <label for="county">County *</label>
        <select id="county" required>
          <option value="">Select County</option>
        </select>
      </div>
      <div class="form-group">
        <label for="city">City *</label>
        <select id="city" required disabled>
          <option value="">Select City</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Address Check -->
  <div class="card" id="section-address">
    <h2>Address</h2>
    <p>Enter the address to check if this voter is already registered.</p>
    
    <div class="form-row">
      <div class="form-group">
        <label for="house-number">House Number *</label>
        <div class="autocomplete-container">
          <input type="text" id="house-number" placeholder="Select street first" required disabled>
          <div id="house-suggestions" class="autocomplete-suggestions"></div>
        </div>
      </div>
      <div class="form-group">
        <label for="street-name">Street Name *</label>
        <div class="autocomplete-container">
          <input type="text" id="street-name" placeholder="Main St" required>
          <div id="street-suggestions" class="autocomplete-suggestions"></div>
        </div>
      </div>
    </div>
    
    <div class="form-group">
      <label for="unit-number">Unit/Apt Number</label>
      <input type="text" id="unit-number" placeholder="Apt 2B">
    </div>
    
    <div id="existing-voter-alert" class="existing-voter" style="display: none;">
      <h3>‚ö†Ô∏è Existing Voter Found</h3>
      <div id="existing-voter-details"></div>
      <p><strong>This voter is already in our database.</strong> You can still record your interaction or update their information.</p>
    </div>
    
  </div>

  <!-- Personal Information -->
  <div class="card" id="section-personal">
    <h2>Personal Information</h2>
    
    <div class="form-row">
      <div class="form-group">
        <label for="first-name">First Name *</label>
        <input type="text" id="first-name" required>
      </div>
      <div class="form-group">
        <label for="last-name">Last Name *</label>
        <input type="text" id="last-name" required>
      </div>
    </div>
    
    <div id="name-match-results" class="search-results"></div>
    
    <div class="form-row">
      <div class="form-group">
        <label for="middle-name">Middle Name</label>
        <input type="text" id="middle-name">
      </div>
      <div class="form-group">
        <label for="suffix">Suffix</label>
        <input type="text" id="suffix" placeholder="Jr, Sr, III">
      </div>
    </div>
    
    <div class="form-group">
      <label for="full-address">Full Address *</label>
      <input type="text" id="full-address" required>
    </div>
    
    <div class="form-row">
      <div class="form-group">
        <label for="zip-code">ZIP Code</label>
        <input type="text" id="zip-code" pattern="[0-9]{5}">
      </div>
      <div class="form-group">
        <label for="phone-primary">Phone Number</label>
        <input type="tel" id="phone-primary">
      </div>
    </div>

    <div class="form-group">
      <label for="email">Email Address</label>
      <input type="email" id="email" placeholder="voter@example.com">
    </div>

    <div class="form-group pulse-optin-block">
      <label class="pulse-optin-label">
        <input type="checkbox" id="pulse-opt-in" class="pulse-optin-checkbox">
        Opt-in to <span class="pulse-term" tabindex="0" data-tooltip="Pulse is our consented texting list. Only voters who explicitly opt in appear in the Pulse table and can receive SMS reminders.">Pulse text updates</span> (voter permission required)
      </label>
      <p class="help-text">
        Get explicit consent before enabling this. We send occasional reminders (polling place info, early voting, events). Message/data rates may apply. Voters can reply STOP to opt out anytime.
      </p>
    </div>
    <div class="form-group" id="pulse-phone-group" style="display:none;">
      <label for="pulse-phone">Cell number for Pulse texts</label>
      <input type="tel" id="pulse-phone" placeholder="e.g. 307-555-1234">
      <p class="help-text">Use the voter‚Äôs preferred mobile number so we log consent correctly.</p>
      <p class="help-text error-text" id="pulse-phone-error" style="display:none;"></p>
    </div>
    
  </div>

  <!-- Interaction & Political Info -->
  <div class="card" id="section-interaction">
    <h2>Interaction Details</h2>
    
    <div class="form-row">
      <div class="form-group">
        <label for="contact-method">How did you meet? *</label>
        <select id="contact-method" required>
          <option value="">Select method</option>
          <option value="door">Door-to-door canvassing</option>
          <option value="phone">Phone call</option>
          <option value="event">At an event</option>
          <option value="referral">Referred by someone</option>
          <option value="online">Online interaction</option>
        </select>
      </div>
      <div class="form-group">
        <label for="estimated-party">Party Affiliation (your assessment)</label>
        <select id="estimated-party">
          <option value="">Unknown</option>
          <option value="Republican">Republican</option>
          <option value="Democratic">Democratic</option>
          <option value="Unaffiliated">Unaffiliated</option>
          <option value="Other">Other</option>
        </select>
      </div>
    </div>
    
    <div class="form-group">
      <label for="voting-likelihood">Likelihood to vote</label>
      <select id="voting-likelihood">
        <option value="unknown">Unknown</option>
        <option value="high">High - Definitely voting</option>
        <option value="medium">Medium - Probably voting</option>
        <option value="low">Low - Unlikely to vote</option>
      </select>
    </div>
    
    <div class="form-group">
      <label for="issues-interested">Issues they're interested in</label>
      <input type="text" id="issues-interested" placeholder="Economy, Healthcare, Education">
    </div>
    
    <div class="form-group">
      <label for="interaction-notes">Conversation notes</label>
      <textarea id="interaction-notes" rows="3" placeholder="What did you discuss?"></textarea>
    </div>
    
    <div class="form-group">
      <label for="volunteer-notes">Your notes</label>
      <textarea id="volunteer-notes" rows="2" placeholder="Any additional notes for follow-up"></textarea>
    </div>
    
    <div class="form-row">
      <button type="button" class="btn-success" id="submit-contact">
        Submit Contact ‚úì
      </button>
    </div>
  </div>

  <!-- Success Message -->
  <div class="card" id="success-message" style="display: none;">
    <h2>‚úÖ Contact Submitted Successfully!</h2>
    <p>Thank you for adding this voter contact. The information has been saved and will be reviewed.</p>
    <div id="success-details" style="background: #f0f9ff; padding: 1rem; border-radius: 6px; margin: 1rem 0; font-family: monospace; font-size: 0.9rem;"></div>
    <button type="button" class="btn-primary" onclick="location.reload()">Add Another Contact</button>
    <button type="button" class="btn-secondary" onclick="location.href='/'">Return to Volunteer Hub</button>
  </div>

  <!-- Hidden input for volunteer's email -->
  <input type="hidden" id="vol-email" value="dev@localhost">

  <button class="btn-primary" onclick="location.href='/ui/contact-form/index.html'">New Contact</button>

  <!-- Shared scripts -->
  <script src="/config/environments.js"></script>
  <script src="/src/apiClient.v2.js?v=2025-10-30a"></script>
  <script src="/shared/authGlobal.js"></script>
  <!-- Import the optimized autocomplete components using streets_index -->
  <script src="../shared/streetAutocompleteOptimized.js"></script>
  <script src="../shared/houseAutocomplete.js"></script>
  
  <script type="module">
    // Progressive form logic with API integration
    const environmentConfig = window.environmentConfig;
    
    let formData = {};
    let potentialMatches = [];
    let wyomingData = {}; // Will hold citiesByCounty data
    let houseAutocomplete; // Declare at module level for access in callbacks
    let streetAutocomplete; // Declare at module level for access in callbacks
    let lookupMatches = [];
    const phonePrimaryInput = document.getElementById('phone-primary');
    const pulseOptInInput = document.getElementById('pulse-opt-in');
    const pulsePhoneGroup = document.getElementById('pulse-phone-group');
    const pulsePhoneInput = document.getElementById('pulse-phone');
    const pulsePhoneError = document.getElementById('pulse-phone-error');

    // Initialize form
    async function init() {
      await loadWyomingData();
      await loadCounties();
      setupEventListeners();
      togglePulsePhoneGroup(pulseOptInInput?.checked, { prefill: true });
    }

    // Load Wyoming data (counties, cities by county, etc.)
    async function loadWyomingData() {
      try {
        const tryPaths = ['/admin/wy.json', '/ui/admin/wy.json'];
        let lastErr = null;
        for (const path of tryPaths) {
          try {
            const response = await fetch(path, { cache: 'no-store' });
            if (response.ok) {
              wyomingData = await response.json();
              console.log('Wyoming data loaded:', wyomingData);
              return;
            }
            lastErr = new Error(`${path} -> HTTP ${response.status}`);
          } catch (e) { 
            lastErr = e; 
          }
        }
        throw lastErr || new Error('wy.json not found');
      } catch (error) {
        console.error('Failed to load Wyoming data:', error);
        // Fallback to API approach
        wyomingData = { counties: [], citiesByCounty: {} };
      }
    }
    
    // Load counties from Wyoming data
    async function loadCounties() {
      try {
        const primarySelect = document.getElementById('county');
        primarySelect.innerHTML = '<option value="">Select County</option>';
        const counties = wyomingData.counties || [];
        
        counties.forEach(county => {
          const option = document.createElement('option');
          option.value = county;
          option.textContent = county;
          primarySelect.appendChild(option);
        });
        
        console.log(`Loaded ${counties.length} counties`);
      } catch (error) {
        console.error('Failed to load counties:', error);
      }
    }

    function populateCityOptions(selectEl, county) {
      if (!selectEl) return;
      selectEl.innerHTML = '<option value="">Select City</option>';
      if (!county) {
        selectEl.disabled = true;
        return;
      }
      const cities = (wyomingData.citiesByCounty && wyomingData.citiesByCounty[county]) || [];
      cities.forEach(city => {
        const option = document.createElement('option');
        option.value = city;
        option.textContent = city;
        selectEl.appendChild(option);
      });
      selectEl.disabled = false;
      if (!cities.length) {
        const fallback = document.createElement('option');
        fallback.value = county;
        fallback.textContent = `${county} County Area`;
        selectEl.appendChild(fallback);
      }
    }
    
    // Setup all event listeners
    function togglePulsePhoneGroup(show, { prefill = false } = {}) {
      if (!pulsePhoneGroup) return;
      pulsePhoneGroup.style.display = show ? '' : 'none';
      if (show && prefill && pulsePhoneInput && phonePrimaryInput) {
        if (!pulsePhoneInput.value) {
          const digits = normalizeTenDigitPhone(phonePrimaryInput.value || '');
          if (digits) pulsePhoneInput.value = digits;
        }
      }
      if (!show && pulsePhoneError) {
        pulsePhoneError.style.display = 'none';
        pulsePhoneError.textContent = '';
      }
    }

    function normalizeTenDigitPhone(rawValue) {
      return (rawValue || '').replace(/\D/g, '').slice(-10);
    }

    function validatePulseOptIn() {
      if (!pulseOptInInput || !pulseOptInInput.checked) {
        if (pulsePhoneError) {
          pulsePhoneError.style.display = 'none';
          pulsePhoneError.textContent = '';
        }
        return { valid: true, digits: '' };
      }
      const digits = normalizeTenDigitPhone(pulsePhoneInput?.value || '');
      if (!digits) {
        if (pulsePhoneError) {
          pulsePhoneError.textContent = 'Enter a 10-digit mobile number before opting in.';
          pulsePhoneError.style.display = 'block';
        }
        pulsePhoneInput?.focus();
        return { valid: false, digits: '' };
      }
      if (pulsePhoneError) {
        pulsePhoneError.style.display = 'none';
        pulsePhoneError.textContent = '';
      }
      return { valid: true, digits };
    }

    function setupEventListeners() {
      // Initialize house autocomplete component
      houseAutocomplete = new HouseAutocomplete({
        houseInputId: 'house-number',
        suggestionsId: 'house-suggestions',
        getCounty: () => formData.county,
        getCity: () => formData.city,
        getStreet: () => formData.streetName,
        onHousesLoaded: (houseNumbers, houseData) => {
          // Store house data for voter lookup
          console.log('üì¶ Storing house data:', houseData.length, 'houses');
          formData.houseData = houseData;
        },
        onHouseSelected: (houseNumber, houseData) => {
          console.log('üè† House selected:', houseNumber, houseData);
          formData.houseNumber = houseNumber;
          checkExistingVoter(houseNumber);
        },
        onHouseInput: (value) => {
          checkAddress();
        }
      });
      
      // Initialize street autocomplete
      streetAutocomplete = new StreetAutocompleteOptimized({
        streetInputId: 'street-name',
        houseInputId: 'house-number',
        suggestionsId: 'street-suggestions',
        getCounty: () => formData.county,
        getCity: () => formData.city,
        onStreetSelected: async (streetName) => {
          console.log('üìç Street selected:', streetName);
          formData.streetName = streetName;
          
          // Enable house field
          houseAutocomplete.enable();
          
          // Load house numbers
          await houseAutocomplete.loadHouseNumbers(streetName);
          
          checkAddress();
        },
        onHouseFieldChange: (enabled) => {
          if (enabled) {
            houseAutocomplete.enable();
          } else {
            houseAutocomplete.disable();
          }
        }
      });
      
      // Initialize house field as disabled
      houseAutocomplete.disable();
      
      document.getElementById('name-search-btn').addEventListener('click', performNameLookup);
      document.getElementById('clear-lookup-btn').addEventListener('click', clearLookupResults);
      document.getElementById('start-contact-btn').addEventListener('click', startNewContactFlow);
      document.getElementById('lookup-results').addEventListener('click', handleLookupResultAction);
      
      // County selection
      document.getElementById('county').addEventListener('change', async (e) => {
        const county = e.target.value;
        formData.county = county;
        
        if (county) {
          await loadCities(county);
          document.getElementById('city').disabled = false;
        }
        // Clear street cache when county changes
        streetAutocomplete.clearCache();
      });
      
      // City selection  
      document.getElementById('city').addEventListener('change', (e) => {
        formData.city = e.target.value;
        // Clear street cache when city changes  
        streetAutocomplete.clearCache();
      });
      
      // Address fields
      document.getElementById('house-number').addEventListener('input', checkAddress);
      
      // Name fields
      document.getElementById('first-name').addEventListener('input', debounce(searchNames, 500));
      document.getElementById('last-name').addEventListener('input', debounce(searchNames, 500));

      pulseOptInInput?.addEventListener('change', () => {
        togglePulsePhoneGroup(pulseOptInInput.checked, { prefill: true });
      });
      pulsePhoneInput?.addEventListener('input', () => {
        if (pulsePhoneError) {
          pulsePhoneError.style.display = 'none';
          pulsePhoneError.textContent = '';
        }
      });
      
      // Submit
      document.getElementById('submit-contact').addEventListener('click', submitContact);
    }
    
    function renderLookupResults(rows, context = {}) {
      const container = document.getElementById('lookup-results');
      lookupMatches = (rows || []).map(row => ({
        ...row,
        county: row.county || null,
        city: row.city || ''
      }));
      if (!lookupMatches.length) {
        container.innerHTML = `<em>No matches found${context.summary ? ` for ${context.summary}` : ''}. Use ‚ÄúAdd New Contact‚Äù to create a record.</em>`;
        return;
      }
      container.innerHTML = lookupMatches
        .map((row, idx) => `
          <div class="match-item">
            <div>
              <strong>${row.name || 'Unknown name'}</strong>
              <span class="match-score">${row.party || 'No party'}</span>
              <div>${row.address || ''}, ${row.city || ''}${row.zip ? ' ' + row.zip : ''}</div>
              ${row.county ? `<div class="match-score">County: ${row.county}</div>` : ''}
              ${row.phone_e164 ? `<div class="match-score">Phone: ${row.phone_e164}</div>` : ''}
            </div>
            <div class="match-actions">
              ${row.voter_id ? `<button class="btn-small btn-primary" data-action="update" data-index="${idx}">Update Record</button>` : ''}
            </div>
          </div>
        `)
        .join('');
    }
    
    function clearLookupResults() {
      lookupMatches = [];
      formData.existingVoter = null;
      document.getElementById('lookup-results').innerHTML = '<em>Enter a name to search existing voters or add a new contact below.</em>';
      document.getElementById('lookup-last-name').value = '';
      document.getElementById('lookup-first-name').value = '';
    }
    
    function handleLookupResultAction(event) {
      const action = event.target.dataset.action;
      if (!action) return;
      const index = Number(event.target.dataset.index || -1);
      if (index < 0 || !lookupMatches[index]) return;
      const voter = lookupMatches[index];
      if (action === 'update') {
        redirectToUpdateForm(voter);
      }
    }
    
    async function performNameLookup() {
      const lastName = document.getElementById('lookup-last-name').value.trim();
      const firstName = document.getElementById('lookup-first-name').value.trim();
      if (lastName.length < 2) {
        document.getElementById('lookup-results').innerHTML = '<em>Enter at least two letters of the last name.</em>';
        return;
      }
      document.getElementById('lookup-results').innerHTML = '<em>Searching records‚Ä¶</em>';
      try {
        const data = await window.apiPost('contact-form/search-names', { firstName, lastName });
        if (!data?.ok) {
          document.getElementById('lookup-results').innerHTML = `<em>${data?.error || 'Search failed'}.</em>`;
          return;
        }
        renderLookupResults(data.rows || [], { summary: `${firstName ? `${firstName} ` : ''}${lastName}`.trim() });
      } catch (error) {
        console.error('Name lookup failed', error);
        document.getElementById('lookup-results').innerHTML = '<em>Unable to search right now. Try again shortly.</em>';
      }
    }
    
    async function startNewContactFlow() {
      formData.existingVoter = null;
      const locationCard = document.getElementById('section-location');
      if (locationCard) {
        locationCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
      document.getElementById('county')?.focus();
    }
    
    // Load actual cities for selected county
    async function loadCities(county) {
      try {
        const select = document.getElementById('city');
        populateCityOptions(select, county);
        if (formData.city) {
          select.value = formData.city;
        }
      } catch (error) {
        console.error('Failed to load cities:', error);
      }
    }

    // Enable house number field
    function enableHouseField() {
      const houseInput = document.getElementById('house-number');
      houseInput.disabled = false;
      houseInput.placeholder = "e.g. 5201";
      houseInput.style.backgroundColor = "";
      houseInput.style.cursor = "";
    }

    // Disable house number field  
    function disableHouseField() {
      const houseInput = document.getElementById('house-number');
      
      houseInput.disabled = true;
      houseInput.value = "";
      houseInput.placeholder = "Select street first";
    }

    
    // Check for existing voter at this address
    async function checkExistingVoter(houseNumber) {
      if (!houseNumber || !formData.streetName) {
        console.log('‚ö†Ô∏è Missing house number or street name');
        return;
      }
      
      console.log('üîç Checking for existing voter at:', houseNumber, formData.streetName);
      
      // Find matching house in our data
      if (!formData.houseData) {
        console.log('‚ö†Ô∏è No house data available yet');
        return;
      }
      
      const matchingHouse = formData.houseData.find(h => h.house_number === houseNumber);
      
      if (matchingHouse && matchingHouse.voter_count > 0) {
        console.log('‚úÖ Found existing voter(s) at this address:', matchingHouse);
        
        // Fetch full voter details from the nearby API with house number filter
        try {
          const data = await window.apiPost('canvass/nearby', {
            filters: {
              county: formData.county,
              city: formData.city
            },
            street: formData.streetName,
            house_number: houseNumber,  // Filter by house number in DB query
            limit: 10  // Only need voters at this specific house
          });
          
          console.log('üì° Voter lookup response:', data);
          
          if (data.ok && data.rows && data.rows.length > 0) {
            console.log(`‚úÖ Found ${data.rows.length} voter(s) at ${houseNumber} ${formData.streetName}`);
            
            showExistingVoterAlert(data.rows);
            
            // Auto-fill first voter's data if only one person at this address
            if (data.rows.length === 1) {
              autoFillVoterData(data.rows[0]);
            }
          } else {
            console.log(`‚ÑπÔ∏è No voters found at ${houseNumber} ${formData.streetName}`);
            document.getElementById('existing-voter-alert').style.display = 'none';
            formData.existingVoter = null;
          }
        } catch (error) {
          console.error('‚ùå Failed to fetch voter details:', error);
          document.getElementById('existing-voter-alert').style.display = 'none';
          formData.existingVoter = null;
        }
      } else {
        console.log('‚ÑπÔ∏è No voters found at this address in house data');
        // Hide alert if no existing voter
        document.getElementById('existing-voter-alert').style.display = 'none';
        formData.existingVoter = null;
      }
    }
    
    // Show alert for existing voter(s)
    function showExistingVoterAlert(voters) {
      const alert = document.getElementById('existing-voter-alert');
      const details = document.getElementById('existing-voter-details');
      
      details.innerHTML = voters.map(voter => `
        <div style="margin: 0.5rem 0; padding: 0.5rem; background: white; border-radius: 4px;">
          <strong>${voter.name}</strong> - ${voter.party || 'Unknown'}
          <br><small>${voter.address}, ${voter.city} ${voter.zip}</small>
          ${voter.phone_e164 ? `<br><small>Phone: ${voter.phone_e164}</small>` : ''}
        </div>
      `).join('');
      
      alert.style.display = 'block';
    }
    
    // Auto-fill form with existing voter data
    function autoFillVoterData(voter) {
      console.log('üìù Auto-filling form with voter data:', voter);
      
      // Store for later
      formData.existingVoter = voter;
      
      // Parse first and last name from combined name
      const nameParts = (voter.name || '').split(' ');
      const firstName = nameParts[0] || '';
      const lastName = nameParts.slice(1).join(' ') || '';
      
      // Auto-advance to step 3 and pre-fill
      setTimeout(() => {
        document.getElementById('first-name').value = firstName;
        document.getElementById('last-name').value = lastName;
        document.getElementById('full-address').value = voter.address || '';
        document.getElementById('zip-code').value = voter.zip || '';
        
        if (voter.phone_e164) {
          document.getElementById('phone-primary').value = voter.phone_e164;
        }
        
        if (voter.party) {
          document.getElementById('estimated-party').value = voter.party;
        }
        
      }, 100);
    }

    // Redirect to update form for existing voters
    function redirectToUpdateForm(voter) {
      console.log('üîÑ Redirecting to update form for existing voter:', voter);
      
      // Store voter data in sessionStorage for the update page
      sessionStorage.setItem('voterUpdateData', JSON.stringify(voter));
      const returnPath = (window.location.pathname + window.location.search) || '/contact-form/';
      sessionStorage.setItem('contactUpdateReturnTo', returnPath);
      
      const params = new URLSearchParams({
        voter_id: voter.voter_id || '',
        return_to: returnPath
      });
      
      // Redirect to update form (relative path)
      window.location.href = `update.html?${params.toString()}`;
    }

    async function checkAddress() {
      const county = formData.county;
      const city = formData.city;
      const street = document.getElementById('street-name').value;
      const number = document.getElementById('house-number').value;
      
      if (!county || !city || !street || !number) {
        document.getElementById('existing-voter-alert').style.display = 'none';
        return;
      }
      
      // Trigger voter lookup when address is complete
      await checkExistingVoter(number);
    }
    
    async function searchNames() {
      const county = formData.county;
      const city = formData.city;
      const firstName = document.getElementById('first-name').value;
      const lastName = document.getElementById('last-name').value;
      
      if (!county || !city || firstName.length < 2 || lastName.length < 2) {
        document.getElementById('name-match-results').innerHTML = '';
        return;
      }
      
      try {
        // For now, disable name search since it requires complex voter lookup
        // This can be enhanced later with proper /api/voters integration
        console.log('Name search temporarily disabled - would search for:', { county, city, firstName, lastName });
        
        const resultsContainer = document.getElementById('name-match-results');
        resultsContainer.innerHTML = `
          <div class="info-message" style="padding: 1rem; background: #eff6ff; border: 1px solid #3b82f6; border-radius: 8px; color: #1e40af;">
            üìù <strong>Note:</strong> Duplicate checking is temporarily unavailable. Please proceed with contact entry.
          </div>
        `;
        return;
        
        // Original code commented out until voter lookup API is integrated:
        /*
        const response = await fetch('/api/voters', {
          method: 'GET',
          // Add appropriate query parameters for voter search
        });
        */
        
        const container = document.getElementById('name-match-results');
        if (matches.length > 0) {
          container.innerHTML = `
            <h4>‚ö†Ô∏è Potential matches found:</h4>
            ${matches.map(match => `
              <div class="potential-match">
                <strong>${match.first_name} ${match.last_name}</strong> - ${match.political_party}
                <br>${match.addr1}, ${match.city}
                <span class="match-score">Match: ${match.match_score}%</span>
              </div>
            `).join('')}
          `;
          potentialMatches = matches;
        } else {
          container.innerHTML = '';
        }
      } catch (error) {
        console.error('Failed to search names:', error);
      }
    }
    
    async function submitContact() {
      const pulseValidation = validatePulseOptIn();
      if (!pulseValidation.valid) return;
      // Collect all form data
      const contactData = {
        county: formData.county,
        city: formData.city,
        streetName: document.getElementById('street-name').value,
        houseNumber: document.getElementById('house-number').value,
        firstName: document.getElementById('first-name').value,
        lastName: document.getElementById('last-name').value,
        middleName: document.getElementById('middle-name').value,
        suffix: document.getElementById('suffix').value,
        fullAddress: document.getElementById('full-address').value,
        unitNumber: document.getElementById('unit-number').value,
        zipCode: document.getElementById('zip-code').value,
        phonePrimary: document.getElementById('phone-primary').value,
        email: document.getElementById('email').value,
        pulseOptIn: !!pulseOptInInput?.checked,
        pulsePhoneDigits: pulseValidation.digits,
        estimatedParty: document.getElementById('estimated-party').value,
        votingLikelihood: document.getElementById('voting-likelihood').value,
        contactMethod: document.getElementById('contact-method').value,
        interactionNotes: document.getElementById('interaction-notes').value,
        issuesInterested: document.getElementById('issues-interested').value,
        volunteerNotes: document.getElementById('volunteer-notes').value,
        potentialMatches: potentialMatches,
        volEmail: document.getElementById('vol-email').value // Add volunteer's email
      };
      
      try {
        const result = await window.apiPost('contact-staging', contactData);
        if (result.ok) {
          // Hide form, show success
          document.querySelector('.step.active').style.display = 'none';
          document.querySelector('.step-indicator').style.display = 'none';
          document.getElementById('success-message').style.display = 'block';
          
          // Update success message with staging info
          document.getElementById('success-details').innerHTML = `
            <p><strong>Submission ID:</strong> ${result.staging_id}</p>
            <p><strong>Temporary Voter ID:</strong> ${result.temp_voter_id}</p>
            <p>This contact will be reviewed and verified before being added to the main database.</p>
          `;
        } else {
          alert('Failed to submit contact: ' + (result.error || 'Unknown error'));
        }
      } catch (error) {
        console.error('Failed to submit contact:', error);
        alert('Failed to submit contact. Please try again.');
      }
    }
    
    // Utility functions
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }
    
    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
