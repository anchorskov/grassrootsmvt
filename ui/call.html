<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="robots" content="noindex, nofollow" />
<title>Volunteer Call</title>
<script>
  // Load environment configuration globally for non-module context
  async function loadEnvironmentConfig() {
    try {
      const module = await import('./config/environments.js');
      window.environmentConfig = module.default || module.environmentConfig;
    } catch (error) {
      console.error('Failed to load environment config:', error);
      // Fallback configuration
      window.environmentConfig = {
        shouldBypassAuth: () => location.hostname === 'localhost' || location.hostname === '127.0.0.1',
        getApiUrl: (endpoint, params = {}) => {
          const isLocal = location.hostname === 'localhost' || location.hostname === '127.0.0.1';
          const baseUrl = isLocal ? 'http://localhost:8787' : 'https://api.grassrootsmvt.org';
          
            // Handle endpoint mapping like the real environment config
            const endpointMap = {
              'ping': '/api/ping',
              'voters': '/api/voters',
              'neighborhoods': '/api/neighborhoods',
              'log': '/api/log',
              'call': '/api/call',
              'whoami': '/api/whoami'
            };          const endpointPath = endpointMap[endpoint] || (endpoint.startsWith('/') ? endpoint : `/api/${endpoint}`);
          let url = `${baseUrl}${endpointPath}`;
          
          if (Object.keys(params).length > 0) {
            const searchParams = new URLSearchParams(params);
            url += `?${searchParams.toString()}`;
          }
          return url;
        },
        debug: (message, data) => {
          const isLocal = location.hostname === 'localhost' || location.hostname === '127.0.0.1';
          if (isLocal) console.log(`[ENV-LOCAL] ${message}`, data || '');
        },
        config: {
          environment: location.hostname === 'localhost' ? 'local' : 'production',
          isLocal: location.hostname === 'localhost' || location.hostname === '127.0.0.1'
        }
      };
    }
  }
  window.envConfigReady = loadEnvironmentConfig();  // Store promise for later
</script>
<script src="/src/apiClient.js"></script>
<style>
  body { font-family: system-ui, sans-serif; margin: 1rem; max-width: 720px; }
  .card { border: 1px solid #ddd; border-radius: 12px; padding: 1rem; margin: 1rem 0; box-shadow: 0 1px 2px rgba(0,0,0,.04); }
  label { display:block; margin:.5rem 0 .25rem; }
  input[type=text], select, textarea { width: 100%; padding:.6rem; border:1px solid #ccc; border-radius:8px; }
  button { padding:.6rem 1rem; border-radius:8px; border:0; background:#0ea5e9; color:white; font-weight:600; cursor:pointer; }
  button.secondary { background:#e2e8f0; color:#0f172a; }
  .row { display:flex; gap:.75rem; flex-wrap: wrap; }
  .row > * { flex:1 1 200px; }
  .muted { color:#64748b; }
  .error { color:#b91c1c; }
  .toolbar { display:flex; gap:.5rem; align-items:center; }
  #voterCard[hidden], #empty[hidden] { display:none; }
  h1 { display:flex; justify-content:space-between; align-items:center; margin:.25rem 0 1rem; }
</style>

<h1>
  <span>Volunteer Call</span>
  <span class="toolbar">
    <button id="getNextBtn" style="padding:8px 12px;border-radius:6px;background:#6aa9ff;color:#fff;border:none;">Get Next</button>
  </span>
</h1>

<div class="card" id="whoami">Checking login‚Ä¶</div>
<div class="card muted" id="filtersBadge" style="display:none;"></div>

<div class="card" id="voterCard" hidden>
  <div id="voterInfo" class="muted"></div>

  <h3>Call outcome</h3>

  <label for="outcome">Outcome</label>
  <select id="outcome">
    <option value="">‚Äî choose ‚Äî</option>
    <option>connected</option><option>vm</option><option>no_answer</option>
    <option>wrong_number</option><option>refused</option><option>follow_up</option>
  </select>

  <div class="row">
    <label><input type="checkbox" id="ok_callback"> OK to call back</label>
    <label><input type="checkbox" id="requested_info"> Requested info</label>
    <label><input type="checkbox" id="dnc"> Do not call</label>
  </div>

  <div class="row">
    <div>
      <label for="best_day">Best day</label>
      <select id="best_day">
        <option value="">‚Äî</option>
        <option>Mon</option><option>Tue</option><option>Wed</option>
        <option>Thu</option><option>Fri</option><option>Sat</option><option>Sun</option>
      </select>
    </div>
    <div>
      <label for="best_time_window">Best time</label>
      <select id="best_time_window">
        <option value="">‚Äî</option>
        <option>Morning</option><option>Afternoon</option><option>Evening</option>
        <option>6‚Äì8pm</option>
      </select>
    </div>
  </div>

  <div class="row">
    <label><input type="checkbox" id="optin_sms"> Opt-in SMS</label>
    <label><input type="checkbox" id="optin_email"> Opt-in Email</label>
  </div>

  <label for="email">Email address (if provided)</label>
  <input type="text" id="email" placeholder="name@example.com"/>

  <div class="row">
    <label><input type="checkbox" id="wants_volunteer"> Wants to volunteer</label>
    <label><input type="checkbox" id="share_insights_ok"> OK to share insights</label>
  </div>
  <div class="row">
    <label><input type="checkbox" id="for_term_limits"> For term limits</label>
    <label><input type="checkbox" id="issue_public_lands"> Interested: public land sales</label>
  </div>

  <label for="comments">Comments</label>
  <textarea id="comments" rows="3"></textarea>

  <div class="row" style="margin-top:.75rem;">
    <button id="saveBtn">Save & Next</button>
    <button class="secondary" id="skipBtn" type="button">Skip</button>
  </div>
  <div id="msg" class="muted" style="margin-top:.5rem;"></div>
</div>

<div class="card" id="empty" hidden>No eligible voters (or not logged in).</div>

<script>
  // Load the API shim which exposes window.apiFetch and API()
  (function(){
    // Load the API shim as an ES module so imports inside it work correctly.
    const s = document.createElement('script');
    s.type = 'module';
    s.src = '/src/api-shim.js';
    document.head.appendChild(s);
  })();

  // Debug snippet: logs token presence and tests /api/ping connectivity
  (function(){
    const dbg = document.createElement('script');
    dbg.textContent = `
      (async () => {
        const token = localStorage.getItem("access_token");
        console.log("üîê Access token present:", !!token);
        if (!token) console.warn("No access_token in localStorage ‚Äî /api/whoami will return 401");
        try {
          // Wait for apiFetch to be available
          await new Promise(resolve => {
            if (window.apiFetch) resolve();
            else setTimeout(resolve, 500);
          });
          const j = await window.apiFetch('ping'); // Remove leading slash
          console.log('üåé /api/ping result:', j);
        } catch (err) {
          console.error('Failed to reach /api/ping:', err);
        }
      })();
    `;
    document.head.appendChild(dbg);
  })();

  // Use environment-aware API URL building instead of hardcoded paths
  const API = (path) => {
    if (window.environmentConfig) {
      // Remove leading slash and /api/ if present, then let getApiUrl handle it
      const cleanPath = path.replace(/^\/?(api\/)?/, '');
      return window.environmentConfig.getApiUrl(cleanPath);
    }
    // Fallback if environment config not loaded yet
    const isLocal = location.hostname === 'localhost' || location.hostname === '127.0.0.1';
    const baseUrl = isLocal ? 'http://localhost:8787' : 'https://api.grassrootsmvt.org';
    const cleanPath = path.replace(/^\/?(api\/)?/, '');
    return `${baseUrl}/api/${cleanPath}`;
  };

  const who = document.getElementById("whoami");
  const voterCard = document.getElementById("voterCard");
  const voterInfo = document.getElementById("voterInfo");
  const empty = document.getElementById("empty");
  const msg = document.getElementById("msg");
  const getNextBtn = document.getElementById('getNextBtn');
  const saveBtn = document.getElementById('saveBtn');
  const skipBtn = document.getElementById('skipBtn');
  const filtersBadge = document.getElementById('filtersBadge');

  function setMsg(text, kind="muted") {
    msg.className = kind;
    msg.textContent = text || "";
  }

  function getUrlFilters() {
    const u = new URL(location.href);
    const parties = u.searchParams.getAll('parties');
    const f = {
      county: (u.searchParams.get('county')||'').toUpperCase() || null,
      city:   (u.searchParams.get('city')||'').toUpperCase() || null,
      district_type: u.searchParams.get('district_type') || null,
      district: u.searchParams.get('district') || null,
      parties: parties.length ? parties : [],
      limit: Number(u.searchParams.get('limit')||50),
      require_phone: true
    };
    return f;
  }

  function getFilters() {
    const fromUrl = getUrlFilters();
    if (fromUrl.county || fromUrl.district_type || fromUrl.parties.length) return fromUrl;
    try { return { ...JSON.parse(sessionStorage.getItem('vol.filters')||'{}'), require_phone:true }; }
    catch { return { require_phone:true }; }
  }

  function showFiltersBadge(filters) {
    filtersBadge.style.display = 'block';
    filtersBadge.textContent = 'Filters: ' + JSON.stringify(filters);
  }

  async function jsonFetch(url, init = {}) {
    console.log('üì° jsonFetch:', url, init.method || 'GET');
    console.log('  window.apiFetch available?', !!window.apiFetch);
    
    // Wait for apiFetch to be available
    if (!window.apiFetch) {
      console.warn('‚è≥ Waiting for apiFetch to be available...');
      let attempts = 0;
      while (!window.apiFetch && attempts < 20) {
        await new Promise(r => setTimeout(r, 100));
        attempts++;
      }
      if (!window.apiFetch) {
        throw new Error('apiFetch not available after waiting');
      }
      console.log('‚úÖ apiFetch now available');
    }
    
    // For API endpoints, use the environment-aware apiFetch
    if (url.includes('/api/')) {
      // Extract the endpoint from the full URL
      const endpointMatch = url.match(/\/api\/(.+)/);
      if (endpointMatch) {
        const endpoint = endpointMatch[1];
        console.log('  ‚Üí Using apiFetch for endpoint:', endpoint);
        const response = await window.apiFetch(endpoint, init);
        console.log('  ‚Üí Response status:', response.status);
        const ct = response.headers.get("content-type") || "";
        return ct.includes("application/json") ? response.json() : response.text();
      }
    }
    
    // Fallback for non-API endpoints
    const r = await fetch(url, {
      credentials: "include",
      ...init,
      headers: { "content-type": "application/json", ...(init.headers || {}) },
    });
    if (r.status === 401) throw new Error("Unauthorized");
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    const ct = r.headers.get("content-type") || "";
    return ct.includes("application/json") ? r.json() : r.text();
  }

  async function loadWho() {
    try {
      const j = await jsonFetch(API("/whoami"));
      who.textContent = j && j.email ? ("Signed in as: " + j.email) : "Not signed in";
    } catch (e) {
      who.innerHTML = `<span class="error">Unable to reach API: ${e.message}</span>`;
    }
  }

  const SEEN_KEY = 'vol.seen_ids';
  function getSeen() {
    try { return JSON.parse(sessionStorage.getItem(SEEN_KEY) || '[]'); } catch { return []; }
  }
  function pushSeen(id) {
    if (!id) return;
    const seen = getSeen().filter(x => x !== id);
    seen.unshift(id);
    sessionStorage.setItem(SEEN_KEY, JSON.stringify(seen.slice(0, 12)));
  }

  let inFlightNext = false;

  async function nextVoter() {
    console.log('üîÑ nextVoter called');
    if (inFlightNext) return;
    inFlightNext = true;
    getNextBtn.disabled = true;
    saveBtn.disabled = true;
    setMsg("Loading next voter‚Ä¶");

    try {
      const filters = getFilters();
      const exclude_ids = getSeen();
      console.log('üìã Filters:', filters, 'Excluding:', exclude_ids);
      const v = await jsonFetch(API('/call'), {
        method: 'POST',
        body: JSON.stringify({ filters, exclude_ids })
      });

      console.log('üì® Received voter data:', v);
      
      if (!v || v.empty || !v.voter_id) {
        console.warn('‚ö†Ô∏è No voter data:', {hasData: !!v, isEmpty: v?.empty, hasVoterId: !!v?.voter_id});
        voterCard.hidden = true; empty.hidden = false; setMsg("");
        return;
      }

      // show
      empty.hidden = true; voterCard.hidden = false;
      voterCard.dataset.voter = v.voter_id;
      const name = [v.first_name, v.last_name].filter(Boolean).join(" ");
      const party = v.political_party ? (' ‚Ä¢ Party: ' + v.political_party) : '';
      const phone = v.phone_1 ? ('Phone: ' + v.phone_1) : 'Phone: ‚Äî';
      voterInfo.innerHTML =
        `<strong>${name || "‚Äî"}</strong><br/>${(v.city||'')} ${(v.county||'')}${party}<br/>${phone}`;

      // remember to avoid immediate repeats
      pushSeen(v.voter_id);                       // NEW
      setMsg("");
    } catch (e) {
      console.error('‚ùå nextVoter error:', e);
      voterCard.hidden = true; empty.hidden = false;
      setMsg(`Error: ${e.message}`, "error");
    } finally {
      inFlightNext = false;
      getNextBtn.disabled = false;
      saveBtn.disabled = false;
    }
  }

  getNextBtn.addEventListener("click", nextVoter);
  saveBtn.addEventListener("click", saveAndNext);

  async function saveAndNext() {
    const payload = {
      voter_id: voterCard.dataset.voter || "",
      outcome: document.getElementById("outcome").value,
      ok_callback: +document.getElementById("ok_callback").checked,
      requested_info: +document.getElementById("requested_info").checked,
      dnc: +document.getElementById("dnc").checked,
      best_day: document.getElementById("best_day").value || null,
      best_time_window: document.getElementById("best_time_window").value || null,
      optin_sms: +document.getElementById("optin_sms").checked,
      optin_email: +document.getElementById("optin_email").checked,
      email: document.getElementById("email").value || null,
      wants_volunteer: +document.getElementById("wants_volunteer").checked,
      share_insights_ok: +document.getElementById("share_insights_ok").checked,
      for_term_limits: +document.getElementById("for_term_limits").checked,
      issue_public_lands: +document.getElementById("issue_public_lands").checked,
      comments: document.getElementById("comments").value || null
    };
    if (!payload.voter_id) { alert("No voter selected."); return; }
    if (!payload.outcome) { alert("Choose an outcome."); return; }

    try {
      setMsg("Saving...");
  await jsonFetch(API("/complete"), { method: "POST", body: JSON.stringify(payload) });
      // reset a few fields
      document.getElementById("outcome").value = "";
      document.getElementById("best_day").value = "";
      document.getElementById("best_time_window").value = "";
      document.getElementById("email").value = "";
      document.getElementById("comments").value = "";
      ["ok_callback","requested_info","dnc","optin_sms","optin_email",
       "wants_volunteer","share_insights_ok","for_term_limits","issue_public_lands"]
       .forEach(id => document.getElementById(id).checked = false);
      setMsg("Saved.");
      // remember and fetch next
      const vid = voterCard.dataset.voter;
      if (vid) pushSeen(vid);
      nextVoter();
    } catch (e) {
      setMsg(`Save failed: ${e.message}`, "error");
    }
  }
  // make Skip also record the current id so we don‚Äôt bounce back to it
  document.getElementById("skipBtn").addEventListener("click", () => {
    const vid = voterCard.dataset.voter;
    if (vid) pushSeen(vid);
    nextVoter();
  });

  // Keyboard shortcut: N = Get Next
  window.addEventListener("keydown", (e) => {
    if (e.key.toLowerCase() === "n" && !e.metaKey && !e.ctrlKey && !e.altKey) {
      e.preventDefault(); nextVoter();
    }
  });

  const filters = getFilters();
  showFiltersBadge(filters);
  (async () => {
    if (window.envConfigReady) await window.envConfigReady;  // Wait for environment
    console.log("‚úÖ Ready, loading data...");
    await loadWho();     // don‚Äôt block if this fails; loadWho() already swallows errors
    await nextVoter();   // show a voter immediately
  })();
</script>
