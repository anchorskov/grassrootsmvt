<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="robots" content="noindex, nofollow" />
<title>Volunteer Call</title>
<script src="/config/environments.js"></script>
<script src="/src/apiClient.v2.js?v=2025-10-30a"></script>
<script src="/shared/authGlobal.js"></script>
<style>
  body { font-family: system-ui, sans-serif; margin: 1rem; max-width: 720px; }
  .card { border: 1px solid #ddd; border-radius: 12px; padding: 1rem; margin: 1rem 0; box-shadow: 0 1px 2px rgba(0,0,0,.04); }
  label { display:block; margin:.5rem 0 .25rem; }
  input[type=text], select, textarea { width: 100%; padding:.6rem; border:1px solid #ccc; border-radius:8px; }
  button { padding:.6rem 1rem; border-radius:8px; border:0; background:#0ea5e9; color:white; font-weight:600; cursor:pointer; }
  button.secondary { background:#e2e8f0; color:#0f172a; }
  .row { display:flex; gap:.75rem; flex-wrap: wrap; }
  .row > * { flex:1 1 200px; }
  .muted { color:#64748b; }
  .error { color:#b91c1c; }
  .toolbar { display:flex; gap:.5rem; align-items:center; }
  #voterCard[hidden], #empty[hidden] { display:none; }
  h1 { display:flex; justify-content:space-between; align-items:center; margin:.25rem 0 1rem; }
  .auth-inline {
    margin: 4px 0 12px;
    padding: 6px 12px;
    border-radius: 8px;
    background: #e0f2fe;
    color: #0f172a;
    font-size: 0.9rem;
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }
  .online-indicator { color: #4caf50; }
  .pulse-optin-block {
    border: 1px solid #fbbf24;
    background: #fef9c3;
    padding: 0.85rem 1rem;
    border-radius: 8px;
    margin: 1rem 0;
  }
  .pulse-optin-label {
    display:flex;
    align-items:center;
    gap:0.6rem;
    font-weight:600;
  }
  .pulse-optin-checkbox {
    width:1.1rem;
    height:1.1rem;
  }
  .help-text { font-size:0.9rem; color:#6b7280; margin-top:0.35rem; }
  .error-text { color:#b91c1c; margin-top:0.3rem; }
  .dnc-note {
    font-size: 0.9rem;
    color: #b45309;
    background: #fef3c7;
    border: 1px solid #fcd34d;
    border-radius: 8px;
    padding: 0.5rem 0.75rem;
    margin: 0.5rem 0 0;
  }
</style>

<h1>
  <span>Volunteer Call</span>
  <span class="toolbar">
    <button id="getNextBtn" style="padding:8px 12px;border-radius:6px;background:#6aa9ff;color:#fff;border:none;">Get Next</button>
  </span>
</h1>
<div class="auth-inline" id="authInline">Checking sign-in‚Ä¶</div>

<div class="card" id="whoami">Checking login‚Ä¶</div>
<div class="card muted" id="filtersBadge" style="display:none;"></div>
<div class="card" id="districtControl" style="display:none; margin-top:12px;">
  <label for="districtTypeSelect" style="font-weight:600;">District focus</label>
  <div class="row" style="margin-top:8px; align-items:flex-end;">
    <div>
      <select id="districtTypeSelect">
        <option value="">‚Äî none ‚Äî</option>
        <option value="house">House District</option>
        <option value="senate">Senate District</option>
      </select>
    </div>
    <div>
      <select id="districtSelect" disabled>
        <option value="">‚Äî select ‚Äî</option>
      </select>
    </div>
    <button id="districtApplyBtn" class="secondary" style="flex:0 0 auto;">Apply</button>
  </div>
  <div class="muted" id="districtControlStatus" style="margin-top:8px;"></div>
</div>

<div class="card" id="voterCard" hidden>
  <div id="voterInfo" class="muted"></div>

  <h3>Call outcome</h3>

  <label for="outcome">Outcome</label>
  <select id="outcome">
    <option value="">‚Äî choose ‚Äî</option>
    <option>connected</option><option>vm</option><option>no_answer</option>
    <option>wrong_number</option><option>refused</option><option>follow_up</option>
  </select>

  <div class="row">
    <label><input type="checkbox" id="ok_callback"> OK to call back</label>
    <label><input type="checkbox" id="requested_info"> Requested info</label>
    <label><input type="checkbox" id="dnc"> Do not call</label>
  </div>
  <p id="dncNote" class="dnc-note" style="display:none;">
    DNC is selected. Outcome is locked to ‚Äúrefused‚Äù and no other info is required. Click ‚ÄúSave &amp; next‚Äù to record this update.
  </p>

  <div class="row">
    <div>
      <label for="best_day">Best day</label>
      <select id="best_day">
        <option value="">‚Äî</option>
        <option>Mon</option><option>Tue</option><option>Wed</option>
        <option>Thu</option><option>Fri</option><option>Sat</option><option>Sun</option>
      </select>
    </div>
    <div>
      <label for="best_time_window">Best time</label>
      <select id="best_time_window">
        <option value="">‚Äî</option>
        <option>Morning</option><option>Afternoon</option><option>Evening</option>
        <option>6‚Äì8pm</option>
      </select>
    </div>
  </div>

  <div class="row">
    <label><input type="checkbox" id="optin_sms"> Opt-in SMS</label>
    <label><input type="checkbox" id="optin_email"> Opt-in Email</label>
  </div>
  <p class="help-text" id="email-note" style="margin-top:-0.35rem;margin-bottom:0;">
    Only check an opt-in if you confirmed the voter‚Äôs preferred phone or email.
  </p>

  <label for="email">Email address (if provided)</label>
  <input type="text" id="email" placeholder="name@example.com"/>
  <p class="help-text error-text" id="email-error" style="display:none;"></p>

  <div class="row">
    <label><input type="checkbox" id="wants_volunteer"> Wants to volunteer</label>
    <label><input type="checkbox" id="share_insights_ok"> OK to share insights</label>
  </div>
  <div class="row">
    <label><input type="checkbox" id="for_term_limits"> For term limits</label>
    <label><input type="checkbox" id="issue_public_lands"> Interested: public land sales</label>
  </div>

  <label for="comments">Comments</label>
  <textarea id="comments" rows="3"></textarea>

  <div class="pulse-optin-block">
    <label class="pulse-optin-label">
      <input type="checkbox" id="pulse-opt-in" class="pulse-optin-checkbox">
      Opt-in to Pulse text updates (voter permission required)
    </label>
    <p class="help-text">
      Ask for explicit consent before enabling this. We send occasional reminders (polling places, early voting). Message/data rates may apply and voters can reply STOP anytime.
    </p>
    <div id="pulse-phone-group" style="display:none; margin-top:0.5rem;">
      <label for="pulse-phone">Cell number for Pulse texts</label>
      <input type="tel" id="pulse-phone" placeholder="e.g. 307-555-1234">
      <p class="help-text">Use the voter‚Äôs preferred mobile number so we log consent correctly.</p>
      <p class="help-text error-text" id="pulse-phone-error" style="display:none;"></p>
    </div>
  </div>

  <div class="row" style="margin-top:.75rem;">
    <button id="saveBtn">Save & Next</button>
    <button class="secondary" id="skipBtn" type="button">Skip</button>
  </div>
  <div id="msg" class="muted" style="margin-top:.5rem;"></div>
</div>

<div class="card" id="empty" hidden>No eligible voters (or not logged in).</div>

<script>

  // Debug snippet: logs token presence and tests /api/ping connectivity
  (function(){
    const dbg = document.createElement('script');
    dbg.textContent = `
      (async () => {
        const token = localStorage.getItem("access_token");
        console.log("üîê Access token present:", !!token);
        if (!token) console.warn("No access_token in localStorage ‚Äî /api/whoami will return 401");
        try {
          // Wait for apiFetch to be available
          await new Promise(resolve => {
            if (window.apiFetch) resolve();
            else setTimeout(resolve, 500);
          });
          const j = await window.apiGet('ping');
          console.log('üåé /api/ping result:', j);
        } catch (err) {
          console.error('Failed to reach /api/ping:', err);
        }
      })();
    `;
    document.head.appendChild(dbg);
  })();

  // Use environment-aware API URL building instead of hardcoded paths
  const API = (path = '', params = {}) => {
    const cleanPath = String(path).replace(/^\/?(api\/)?/, '');
    if (window.environmentConfig && typeof window.environmentConfig.getApiUrl === 'function') {
      return window.environmentConfig.getApiUrl(cleanPath, params);
    }
    const qs = new URLSearchParams(params);
    return `/api/${cleanPath}${qs.toString() ? `?${qs}` : ''}`;
  };

  const who = document.getElementById("whoami");
  const voterCard = document.getElementById("voterCard");
  const voterInfo = document.getElementById("voterInfo");
  const empty = document.getElementById("empty");
const msg = document.getElementById("msg");
const getNextBtn = document.getElementById('getNextBtn');
const saveBtn = document.getElementById('saveBtn');
const skipBtn = document.getElementById('skipBtn');
const filtersBadge = document.getElementById('filtersBadge');
const districtControl = document.getElementById('districtControl');
const districtTypeSelect = document.getElementById('districtTypeSelect');
const districtSelect = document.getElementById('districtSelect');
const districtApplyBtn = document.getElementById('districtApplyBtn');
const districtControlStatus = document.getElementById('districtControlStatus');
const optInSmsCheckbox = document.getElementById('optin_sms');
const optInEmailCheckbox = document.getElementById('optin_email');
const pulseOptInCheckbox = document.getElementById('pulse-opt-in');
const pulsePhoneInput = document.getElementById('pulse-phone');
const pulsePhoneGroup = document.getElementById('pulse-phone-group');
const pulsePhoneError = document.getElementById('pulse-phone-error');
const emailInput = document.getElementById('email');
const emailError = document.getElementById('email-error');
let districtMetadata = null;
let currentVoterPhone = '';

function setMsg(text, kind="muted") {
  msg.className = kind;
  msg.textContent = text || "";
}

function normalizePhoneDigits(value) {
  if (!value) return '';
  return value.replace(/\D/g, '');
}

function normalizeTenDigitPhone(value) {
  let digits = normalizePhoneDigits(value);
  if (digits.length === 11 && digits.startsWith('1')) {
    digits = digits.slice(1);
  }
  return digits;
}

function togglePulsePhoneGroup(show, { prefill = false } = {}) {
  if (!pulsePhoneGroup) return;
  pulsePhoneGroup.style.display = show ? 'block' : 'none';
  if (show && prefill && pulsePhoneInput && !pulsePhoneInput.value) {
    const digits = normalizeTenDigitPhone(currentVoterPhone);
    if (digits.length === 10) {
      pulsePhoneInput.value = digits;
    } else if (currentVoterPhone) {
      pulsePhoneInput.value = currentVoterPhone;
    }
  }
  if (!show && pulsePhoneError) {
    pulsePhoneError.style.display = 'none';
    pulsePhoneError.textContent = '';
  }
}

function syncPulseOptIn(checked, { prefill = false, resetPhone = false } = {}) {
  if (optInSmsCheckbox && optInSmsCheckbox.checked !== checked) {
    optInSmsCheckbox.checked = checked;
  }
  if (pulseOptInCheckbox && pulseOptInCheckbox.checked !== checked) {
    pulseOptInCheckbox.checked = checked;
  }
  togglePulsePhoneGroup(checked, { prefill });
  if (!checked && resetPhone && pulsePhoneInput) {
    pulsePhoneInput.value = normalizeTenDigitPhone(currentVoterPhone) || currentVoterPhone || '';
  }
}

function validatePulsePhone() {
  const wantsPulse = !!(optInSmsCheckbox?.checked || pulseOptInCheckbox?.checked);
  if (!wantsPulse) {
    if (pulsePhoneError) {
      pulsePhoneError.style.display = 'none';
      pulsePhoneError.textContent = '';
    }
    return { valid: true, digits: '' };
  }
  const digits = normalizeTenDigitPhone(pulsePhoneInput?.value || '');
  if (digits.length !== 10) {
    if (pulsePhoneError) {
      pulsePhoneError.textContent = 'Enter a 10-digit mobile number before logging consent.';
      pulsePhoneError.style.display = 'block';
    }
    pulsePhoneInput?.focus();
    return { valid: false, digits: '' };
  }
  if (pulsePhoneError) {
    pulsePhoneError.style.display = 'none';
    pulsePhoneError.textContent = '';
  }
  return { valid: true, digits };
}

function isValidEmail(value) {
  if (!value) return false;
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  return emailRegex.test(value.trim());
}

function validateEmailOptIn() {
  if (!optInEmailCheckbox) return true;
  if (!optInEmailCheckbox.checked) {
    if (emailError) {
      emailError.style.display = 'none';
      emailError.textContent = '';
    }
    return true;
  }
  const value = emailInput?.value || '';
  if (!isValidEmail(value)) {
    if (emailError) {
      emailError.textContent = 'Enter a valid email address before logging email consent.';
      emailError.style.display = 'block';
    }
    emailInput?.focus();
    return false;
  }
  if (emailError) {
    emailError.style.display = 'none';
    emailError.textContent = '';
  }
  return true;
}

async function recordPulseOptIn(voterId, digits) {
  if (!voterId || !digits) return;
  const e164 = digits.startsWith('+') ? digits : `+1${digits}`;
  try {
    if (typeof window.apiPost === 'function') {
      await window.apiPost('pulse', {
        voter_id: voterId,
        contact_method: 'sms',
        consent_source: 'call',
        phone: e164,
      });
    } else if (typeof window.apiFetch === 'function') {
      await window.apiFetch('pulse', {
        method: 'POST',
        body: JSON.stringify({
          voter_id: voterId,
          contact_method: 'sms',
          consent_source: 'call',
          phone: e164,
        }),
      });
    } else {
      await fetch(API('/pulse'), {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          voter_id: voterId,
          contact_method: 'sms',
          consent_source: 'call',
          phone: e164,
        }),
      });
    }
    console.log('üì≤ Pulse opt-in recorded for', voterId);
  } catch (err) {
    console.warn('‚ö†Ô∏è Pulse opt-in recording failed', err);
  }
}

  function getUrlFilters() {
    const u = new URL(location.href);
    const parties = u.searchParams.getAll('parties');
    const f = {
      county: (u.searchParams.get('county')||'').toUpperCase() || null,
      city:   (u.searchParams.get('city')||'').toUpperCase() || null,
      district_type: u.searchParams.get('district_type') || null,
      district: u.searchParams.get('district') || null,
      parties: parties.length ? parties : [],
      limit: Number(u.searchParams.get('limit')||50),
      require_phone: true
    };
    return f;
  }

  function getFilters() {
    const fromUrl = getUrlFilters();
    if (fromUrl.county || fromUrl.district_type || fromUrl.parties.length) {
      const cleaned = { ...fromUrl, require_phone: true };
      if (!cleaned.district_type || !cleaned.district) {
        delete cleaned.district_type;
        delete cleaned.district;
      }
      return cleaned;
    }
    try {
      const stored = JSON.parse(sessionStorage.getItem('vol.filters') || '{}');
      delete stored.district_type;
      delete stored.district;
      return { ...stored, require_phone: true };
    } catch {
      return { require_phone: true };
    }
  }

  function showFiltersBadge(filters) {
    filtersBadge.style.display = 'block';
    filtersBadge.textContent = 'Filters: ' + JSON.stringify(filters);
    updateDistrictControlStatus(filters);
  }

  function populateDistrictSelect(type) {
    if (!districtSelect || !districtMetadata) return;
    districtSelect.innerHTML = '<option value="">‚Äî select ‚Äî</option>';
    if (!type) {
      districtSelect.disabled = true;
      return;
    }
    const list =
      type === 'senate'
        ? (districtMetadata.senate_districts || [])
        : (districtMetadata.house_districts || []);
    list.forEach(code => {
      const opt = document.createElement('option');
      opt.value = code;
      opt.textContent = `${type === 'senate' ? 'SD' : 'HD'} ${code}`;
      districtSelect.appendChild(opt);
    });
    districtSelect.disabled = false;
  }

  function updateDistrictControlStatus(filters) {
    if (!districtControlStatus) return;
    if (filters?.district_type && filters?.district) {
      districtControlStatus.textContent = `Targeting ${filters.district_type === 'senate' ? 'Senate' : 'House'} District ${filters.district}.`;
    } else {
      districtControlStatus.textContent = 'No district focus.';
    }
  }

  async function initDistrictControl() {
    if (!districtControl || districtMetadata) return;
    const filters = getFilters();
    const hasDistrict = filters.district_type && filters.district;
    if (!hasDistrict) {
      districtControl.style.display = 'none';
      return;
    }
    try {
      const resp = await fetch('/api/metadata', { headers: { Accept: 'application/json' } });
      if (!resp.ok) throw new Error(`metadata ${resp.status}`);
      districtMetadata = await resp.json();
      districtControl.style.display = '';
      updateDistrictControlStatus(filters);
      if (filters.district_type) {
        districtTypeSelect.value = filters.district_type;
        populateDistrictSelect(filters.district_type);
        districtSelect.value = filters.district || '';
      } else {
        districtSelect.disabled = true;
      }
    } catch (err) {
      console.warn('District metadata unavailable', err);
      districtControl.style.display = 'none';
      districtMetadata = null;
      return;
    }

    districtTypeSelect.addEventListener('change', () => {
      const type = districtTypeSelect.value;
      populateDistrictSelect(type);
      if (!type) {
        districtSelect.value = '';
      }
    });

    districtApplyBtn.addEventListener('click', event => {
      event.preventDefault();
      applyDistrictSelection();
    });
  }

  function applyDistrictSelection() {
    const type = districtTypeSelect.value || null;
    const district = districtSelect.value || null;
    if (hasFormData()) {
      const proceed = confirm('You have unsaved call data. Changing districts will load a new voter and discard the current form. Continue?');
      if (!proceed) return;
    }
    const filters = { ...getFilters() };
    const url = new URL(location.href);
    if (type && district) {
      filters.district_type = type;
      filters.district = district;
      url.searchParams.set('district_type', type);
      url.searchParams.set('district', district);
    } else {
      delete filters.district_type;
      delete filters.district;
      url.searchParams.delete('district_type');
      url.searchParams.delete('district');
    }
    sessionStorage.setItem('vol.filters', JSON.stringify(filters));
    clearSeen();
    history.replaceState(null, '', url);
    showFiltersBadge(filters);
    nextVoter(true);
  }

  async function jsonFetch(url, init = {}) {
    if (typeof window.apiFetch !== 'function') {
      throw new Error('apiClient not ready');
    }
    const path = String(url).replace(/^\/?api\/?/, '');
    const response = await window.apiFetch(path, init);
    const text = await response.text().catch(() => '');
    if (!response.ok) {
      const error = new Error(`HTTP ${response.status}`);
      error.status = response.status;
      error.body = text;
      throw error;
    }
    if (!text) return null;
    try {
      return JSON.parse(text);
    } catch {
      return text;
    }
  }

  async function loadWho() {
    try {
      const j = await jsonFetch(API("/whoami"));
      who.textContent = j && j.email ? ("Signed in as: " + j.email) : "Not signed in";
    } catch (e) {
      who.innerHTML = `<span class="error">Unable to reach API: ${e.message}</span>`;
    }
  }

  const SEEN_KEY = 'vol.seen_ids';
  function getSeen() {
    try { return JSON.parse(sessionStorage.getItem(SEEN_KEY) || '[]'); } catch { return []; }
  }
  function clearSeen() {
    sessionStorage.removeItem(SEEN_KEY);
  }
  function pushSeen(id) {
    if (!id) return;
    const seen = getSeen().filter(x => x !== id);
    seen.unshift(id);
    sessionStorage.setItem(SEEN_KEY, JSON.stringify(seen.slice(0, 12)));
  }

  let inFlightNext = false;
  let lastOutcomeBeforeDnc = '';

  // Reset the form to blank state
  function resetForm() {
    lastOutcomeBeforeDnc = '';
    currentVoterPhone = '';
    document.getElementById("outcome").value = "";
    document.getElementById("best_day").value = "";
    document.getElementById("best_time_window").value = "";
    document.getElementById("email").value = "";
    document.getElementById("comments").value = "";
    ["ok_callback","requested_info","dnc","optin_sms","optin_email",
     "wants_volunteer","share_insights_ok","for_term_limits","issue_public_lands"]
     .forEach(id => document.getElementById(id).checked = false);
    enforceDncMode();
    syncPulseOptIn(false, { resetPhone: true });
    if (pulsePhoneInput) {
      pulsePhoneInput.value = '';
    }
  }

  // Check if user has entered any meaningful data
  function hasFormData() {
    const outcome = document.getElementById("outcome").value;
    const email = document.getElementById("email").value.trim();
    const comments = document.getElementById("comments").value.trim();
    const bestDay = document.getElementById("best_day").value;
    const bestTime = document.getElementById("best_time_window").value;
    
    // Check if any checkbox is checked
    const anyCheckbox = ["ok_callback","requested_info","dnc","optin_sms","optin_email",
       "wants_volunteer","share_insights_ok","for_term_limits","issue_public_lands"]
       .some(id => document.getElementById(id).checked);
    
    // Has data if: outcome selected OR any other field filled OR any checkbox checked
    return outcome || email || comments || bestDay || bestTime || anyCheckbox;
  }

  async function nextVoter(skipPrompt = false) {
    console.log('üîÑ nextVoter called, skipPrompt:', skipPrompt);
    
    // Check for unsaved data unless we're explicitly skipping the prompt
    if (!skipPrompt && hasFormData()) {
      const userChoice = confirm("You have unsaved data. Do you want to save before moving to the next voter?\n\nClick OK to save, or Cancel to discard changes.");
      if (userChoice) {
        // User wants to save
        await saveAndNext();
        return;
      }
      // User chose to discard - continue to next voter
    }
    
    if (inFlightNext) return;
    inFlightNext = true;
    getNextBtn.disabled = true;
    saveBtn.disabled = true;
    setMsg("Loading next voter‚Ä¶");

    try {
      const filters = getFilters();
      const exclude_ids = getSeen();
      console.log('üìã Filters:', filters, 'Excluding:', exclude_ids);
      const v = await jsonFetch(API('/call'), {
        method: 'POST',
        body: JSON.stringify({ filters, exclude_ids })
      });

      console.log('üì® Received voter data:', v);
      
      if (!v || v.empty || !v.voter_id) {
        console.warn('‚ö†Ô∏è No voter data:', {hasData: !!v, isEmpty: v?.empty, hasVoterId: !!v?.voter_id});
        voterCard.hidden = true; empty.hidden = false; setMsg("");
        return;
      }

      // Reset form before showing new voter
      resetForm();
      currentVoterPhone = v.phone_e164 || v.phone_1 || v.phone || '';
      if (pulsePhoneInput) {
        const digits = normalizeTenDigitPhone(currentVoterPhone);
        pulsePhoneInput.value = digits || currentVoterPhone || '';
      }
      syncPulseOptIn(false, { resetPhone: true });
      
      // show
      empty.hidden = true; voterCard.hidden = false;
      voterCard.dataset.voter = v.voter_id;
      const name = [v.first_name, v.last_name].filter(Boolean).join(" ");
      const phone = v.phone_1 ? ('Phone: ' + v.phone_1) : 'Phone: ‚Äî';
      const districtBits = [
        v.house_district ? `HD ${v.house_district}` : null,
        v.senate_district ? `SD ${v.senate_district}` : null,
      ].filter(Boolean).join(' ‚Ä¢ ');
      const lineParts = [
        [v.city, v.county].filter(Boolean).join(', ').trim() || null,
        v.political_party ? `Party: ${v.political_party}` : null,
        districtBits || null,
      ].filter(Boolean);
      const details = lineParts.join(' ‚Ä¢ ');
      const detailsHtml = details ? `${details}<br/>` : '';
      voterInfo.innerHTML =
        `<strong>${name || "‚Äî"}</strong><br/>${detailsHtml}${phone}`;

      // remember to avoid immediate repeats
      pushSeen(v.voter_id);
      setMsg("");
    } catch (e) {
      console.error('‚ùå nextVoter error:', e);
      voterCard.hidden = true; empty.hidden = false;
      setMsg(`Error: ${e.message}`, "error");
    } finally {
      inFlightNext = false;
      getNextBtn.disabled = false;
      saveBtn.disabled = false;
    }
  }

  getNextBtn.addEventListener("click", nextVoter);
  saveBtn.addEventListener("click", saveAndNext);

  async function saveAndNext() {
    const voter_id = voterCard.dataset.voter || "";
    
    if (!voter_id) { 
      alert("No voter selected."); 
      return; 
    }
    const wantsPulse = !!(optInSmsCheckbox?.checked || pulseOptInCheckbox?.checked);
    const pulseValidation = wantsPulse ? validatePulsePhone() : { valid: true, digits: '' };
    if (!pulseValidation.valid) return;
    
    // Check if there's any meaningful data to save
    if (!hasFormData()) {
      console.log('‚ÑπÔ∏è No data entered, skipping save and moving to next voter');
      // Just move to next without saving
      nextVoter(true); // skipPrompt = true to avoid recursive prompt
      return;
    }
    
    const outcome = document.getElementById("outcome").value;
    if (!outcome) { 
      alert("Choose an outcome to save the call record."); 
      return; 
    }
    
    if (!validateEmailOptIn()) return;

    if (document.getElementById("requested_info").checked) {
      const comments = document.getElementById("comments").value.trim();
      if (!comments) {
        alert("Add a note describing what information was requested before saving.");
        document.getElementById("comments").focus();
        return;
      }
    }

    const payload = {
      voter_id: voter_id,
      contact_method: 'phone',
      outcome: outcome,
      comments: document.getElementById("comments").value || null,
      // Additional call-specific fields
      ok_callback: +document.getElementById("ok_callback").checked,
      requested_info: +document.getElementById("requested_info").checked,
      dnc: +document.getElementById("dnc").checked,
      best_day: document.getElementById("best_day").value || null,
      best_time_window: document.getElementById("best_time_window").value || null,
      optin_sms: wantsPulse ? 1 : 0,
      optin_email: optInEmailCheckbox?.checked ? 1 : 0,
      email: emailInput?.value || null,
      wants_volunteer: +document.getElementById("wants_volunteer").checked,
      share_insights_ok: +document.getElementById("share_insights_ok").checked,
      for_term_limits: +document.getElementById("for_term_limits").checked,
      issue_public_lands: +document.getElementById("issue_public_lands").checked
    };

    try {
      setMsg("Saving...");
      await jsonFetch(API("/contact"), { method: "POST", body: JSON.stringify(payload) });
      if (wantsPulse && pulseValidation.digits) {
        await recordPulseOptIn(voter_id, pulseValidation.digits);
      }
      setMsg("Saved.");
      // remember and fetch next (form will be reset in nextVoter)
      const vid = voterCard.dataset.voter;
      if (vid) pushSeen(vid);
      window.scrollTo({ top: 0, behavior: 'smooth' });
      nextVoter(true); // skipPrompt = true since we just saved
    } catch (e) {
      setMsg(`Save failed: ${e.message}`, "error");
    }
  }
  // Skip button - intentionally discards data without saving
  document.getElementById("skipBtn").addEventListener("click", () => {
    const vid = voterCard.dataset.voter;
    if (vid) pushSeen(vid);
    nextVoter(true); // skipPrompt = true, user explicitly chose to skip
  });

  // Keyboard shortcut: N = Get Next (only when not typing in input fields)
  window.addEventListener("keydown", (e) => {
    // Don't trigger if user is typing in an input, textarea, or other editable element
    const target = e.target;
    const isInputField = target.tagName === 'INPUT' || 
                        target.tagName === 'TEXTAREA' || 
                        target.isContentEditable;
    
    const key = (e.key || '').toLowerCase();
    if (key === "n" && !e.metaKey && !e.ctrlKey && !e.altKey && !isInputField) {
      e.preventDefault(); 
      nextVoter(); // Will prompt if data exists
    }
  });

const filters = getFilters();
showFiltersBadge(filters);
initDistrictControl();
if (optInSmsCheckbox) {
  optInSmsCheckbox.addEventListener('change', () => {
    syncPulseOptIn(!!optInSmsCheckbox.checked, { prefill: true });
  });
}
if (pulseOptInCheckbox) {
  pulseOptInCheckbox.addEventListener('change', () => {
    syncPulseOptIn(!!pulseOptInCheckbox.checked, { prefill: true });
  });
}
if (optInEmailCheckbox && emailInput) {
  optInEmailCheckbox.addEventListener('change', () => {
    validateEmailOptIn();
  });
  emailInput.addEventListener('blur', () => validateEmailOptIn());
  emailInput.addEventListener('input', () => {
    if (optInEmailCheckbox.checked) {
      validateEmailOptIn();
    } else if (emailError) {
      emailError.style.display = 'none';
      emailError.textContent = '';
    }
  });
}

  const dncCheckbox = document.getElementById('dnc');
  const outcomeSelect = document.getElementById('outcome');
  const dncNote = document.getElementById('dncNote');
  const dncSensitiveSelectors = [
    '#ok_callback',
    '#requested_info',
    '#best_day',
    '#best_time_window',
    '#optin_sms',
    '#optin_email',
    '#email',
    '#wants_volunteer',
    '#share_insights_ok',
    '#for_term_limits',
    '#issue_public_lands',
    '#comments',
    '#pulse-opt-in',
    '#pulse-phone'
  ];
  const dncSensitiveFields = dncSensitiveSelectors
    .map(sel => document.querySelector(sel))
    .filter(Boolean);

  function enforceDncMode() {
    const checked = !!dncCheckbox?.checked;
    if (!checked) {
      if (outcomeSelect) {
        outcomeSelect.disabled = false;
        if (outcomeSelect.value === 'refused') {
          outcomeSelect.value = lastOutcomeBeforeDnc || '';
        }
      }
    dncSensitiveFields.forEach(field => {
      if (!field) return;
      field.disabled = field.dataset.prevDisabled === '1';
      delete field.dataset.prevDisabled;
    });
      if (dncNote) dncNote.style.display = 'none';
      return;
    }

    syncPulseOptIn(false, { resetPhone: true });

    if (outcomeSelect) {
      if (outcomeSelect.value && outcomeSelect.value !== 'refused') {
        lastOutcomeBeforeDnc = outcomeSelect.value;
      }
      outcomeSelect.value = 'refused';
      outcomeSelect.disabled = true;
    }

    dncSensitiveFields.forEach(field => {
      if (!field.disabled) {
        field.dataset.prevDisabled = '0';
      } else {
        field.dataset.prevDisabled = '1';
      }
      field.disabled = true;
      if (field.type === 'checkbox' || field.type === 'radio') {
        field.checked = false;
      } else if (field.tagName === 'SELECT') {
        field.selectedIndex = 0;
      } else if (field.tagName === 'TEXTAREA' || field.tagName === 'INPUT') {
        field.value = '';
      }
    });

    if (dncNote) dncNote.style.display = 'block';
  }

  dncCheckbox?.addEventListener('change', enforceDncMode);
  enforceDncMode();

  (async () => {
    console.log("‚úÖ Ready, loading data...");
    await loadWho();     // don‚Äôt block if this fails; loadWho() already swallows errors
    await nextVoter();   // show a voter immediately
  })();
</script>
<script type="module">
  import { mountLogoutButton } from '/shared/logoutButton.js';
  import { initSessionTimeout } from '/shared/sessionTimeout.js';

  mountLogoutButton({ position: 'top-right' });
  initSessionTimeout({
    idleMinutes: 20,
    graceMinutes: 10,
  });
</script>
<script type="module">
  import { initHelpModal } from '../shared/helpModal.js';
  initHelpModal({
    helpPath: '/help/call.md',
    title: 'Call Workflow Instructions',
    toggleLabel: 'Help',
    position: 'top-right',
  });
</script>
<script>
  (function () {
    const authInline = document.getElementById('authInline');
    if (!authInline) return;

    const render = state => {
      const email = state?.user?.email || null;
      if (state?.authenticated && email) {
        authInline.textContent = `Signed in as ${email}`;
        authInline.style.background = '#dcfce7';
        authInline.style.color = '#065f46';
      } else {
        authInline.textContent = 'Not signed in';
        authInline.style.background = '#fee2e2';
        authInline.style.color = '#991b1b';
      }
    };

    const bind = () => {
      window.authGlobal.onAuthChange(render);
      render(window.authGlobal);
    };

    if (window.authGlobal?.ready) {
      bind();
    } else {
      window.addEventListener(
        'authGlobalReady',
        () => {
          bind();
        },
        { once: true }
      );
    }
  })();
</script>
