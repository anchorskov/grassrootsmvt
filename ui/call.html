<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="robots" content="noindex, nofollow" />
  <title>Volunteer Call</title>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 1rem; max-width: 880px; }
    .card { border:1px solid #e5e7eb; border-radius: 12px; padding: 1rem; margin: 1rem 0; box-shadow: 0 1px 2px rgba(0,0,0,.04); }
    .row { display:flex; gap:.75rem; flex-wrap: wrap; }
    .row > * { flex:1 1 220px; }
    label { display:block; margin:.4rem 0 .25rem; font-weight:600; }
    select, input[type=text], textarea { width:100%; padding:.6rem; border:1px solid #cbd5e1; border-radius:8px; }
    textarea { min-height: 90px; }
    .muted { color:#64748b; }
    .btns { display:flex; gap:.75rem; flex-wrap: wrap; margin-top:.75rem; align-items:center; }
    button { padding:.7rem 1.1rem; border-radius:10px; border:0; font-weight:700; cursor:pointer; }
    button.primary { background:#0ea5e9; color:white; }
    button.secondary { background:#e2e8f0; color:#0f172a; }
    button[disabled] { opacity:.5; cursor:not-allowed; }
    a { color:#0ea5e9; text-decoration: none; }
    #voterCard[hidden], #empty[hidden] { display:none; }
    h1 { display:flex; justify-content:space-between; align-items:center; margin:.25rem 0 1rem; }
    .toolbar { display:flex; gap:.5rem; align-items:center; }
    #filtersBadge { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
  </style>
</head>

<body>
  <h1>
    <span>Volunteer Call</span>
    <span class="toolbar">
      <button id="getNextBtn" class="primary">Get Next</button>
    </span>
  </h1>

  <div class="card" id="whoami">Checking loginâ€¦</div>
  <div class="card muted" id="filtersBadge" style="display:none;"></div>

  <div class="card" id="voterCard" hidden>
    <div id="voterInfo" class="muted"></div>

    <h3>Call outcome</h3>

    <label for="outcome">Outcome</label>
    <select id="outcome">
      <option value="">â€” choose â€”</option>
      <option>connected</option><option>vm</option><option>no_answer</option>
      <option>wrong_number</option><option>refused</option><option>follow_up</option>
    </select>

    <div class="row">
      <label><input type="checkbox" id="ok_callback"> OK to call back</label>
      <label><input type="checkbox" id="requested_info"> Requested info</label>
      <label><input type="checkbox" id="dnc"> Do not call</label>
    </div>

    <div class="row">
      <div>
        <label for="best_day">Best day</label>
        <select id="best_day">
          <option value="">â€”</option>
          <option>Mon</option><option>Tue</option><option>Wed</option>
          <option>Thu</option><option>Fri</option><option>Sat</option><option>Sun</option>
        </select>
      </div>
      <div>
        <label for="best_time_window">Best time</label>
        <select id="best_time_window">
          <option value="">â€”</option>
          <option>Morning</option><option>Afternoon</option><option>Evening</option>
          <option>6â€“8pm</option>
        </select>
      </div>
    </div>

    <div class="row">
      <label><input type="checkbox" id="optin_sms"> Opt-in SMS</label>
      <label><input type="checkbox" id="optin_email"> Opt-in Email</label>
    </div>

    <label for="email">Email address (if provided)</label>
    <input type="text" id="email" placeholder="name@example.com"/>

    <div class="row">
      <label><input type="checkbox" id="wants_volunteer"> Wants to volunteer</label>
      <label><input type="checkbox" id="share_insights_ok"> OK to share insights</label>
    </div>
    <div class="row">
      <label><input type="checkbox" id="for_term_limits"> For term limits</label>
      <label><input type="checkbox" id="issue_public_lands"> Interested: public land sales</label>
    </div>

    <label for="comments">Comments</label>
    <textarea id="comments" rows="3"></textarea>

    <div class="btns">
      <button id="saveBtn" class="primary">Save & Next</button>
      <button id="skipBtn" class="secondary" type="button">Skip</button>
      <span id="msg" class="muted"></span>
    </div>
  </div>

  <div class="card" id="empty" hidden>No eligible voters (or not logged in).</div>

  <!-- Main app logic as an ES module so imports are guaranteed -->
  <script type="module">
    // Import env (optional) and the API client as a module â€“ no window.* reliance
    let environmentConfig = null;
    try {
      const envMod = await import('/config/environments.js');
      environmentConfig = envMod.default || envMod.environmentConfig || envMod;
      // expose for other non-module scripts if needed
      window.environmentConfig = environmentConfig;
    } catch (e) {
      console.warn('env import failed, proceeding with apiClient fallbacks', e);
    }

    import { apiGet, apiPost } from '/src/apiClient.js';

    // ----- UI elements
    const who        = document.getElementById('whoami');
    const voterCard  = document.getElementById('voterCard');
    const voterInfo  = document.getElementById('voterInfo');
    const empty      = document.getElementById('empty');
    const msg        = document.getElementById('msg');
    const getNextBtn = document.getElementById('getNextBtn');
    const saveBtn    = document.getElementById('saveBtn');
    const skipBtn    = document.getElementById('skipBtn');
    const filtersBadge = document.getElementById('filtersBadge');

    function setMsg(text, kind="muted") {
      msg.className = kind;
      msg.textContent = text || "";
    }

    // ----- Filters from URL
    function getUrlFilters() {
      const u = new URL(location.href);
      const parties = u.searchParams.getAll('parties');
      const f = {
        county: (u.searchParams.get('county')||'').toUpperCase() || null,
        city:   (u.searchParams.get('city')||'').toUpperCase() || null,
        district_type: u.searchParams.get('district_type') || null,
        district: u.searchParams.get('district') || null,
        parties: parties.length ? parties : [],
        limit: Number(u.searchParams.get('limit')||50),
        require_phone: true
      };
      return f;
    }
    function getFilters() {
      const fromUrl = getUrlFilters();
      if (fromUrl.county || fromUrl.district_type || fromUrl.parties.length) return fromUrl;
      try { return { ...JSON.parse(sessionStorage.getItem('vol.filters')||'{}'), require_phone:true }; }
      catch { return { require_phone:true }; }
    }
    function showFiltersBadge(filters) {
      filtersBadge.style.display = 'block';
      filtersBadge.textContent = 'Filters: ' + JSON.stringify(filters);
    }

    // ----- Seen IDs cache
    const SEEN_KEY = 'vol.seen_ids';
    function getSeen() {
      try { return JSON.parse(sessionStorage.getItem(SEEN_KEY) || '[]'); } catch { return []; }
    }
    function pushSeen(id) {
      if (!id) return;
      const seen = getSeen().filter(x => x !== id);
      seen.unshift(id);
      sessionStorage.setItem(SEEN_KEY, JSON.stringify(seen.slice(0, 12)));
    }

    // ----- Render & actions
    function renderVoter(v) {
      if (!v) {
        voterCard.hidden = true;
        empty.hidden = false;
        setMsg("");
        return;
      }
      empty.hidden = true;
      voterCard.hidden = false;
      voterCard.dataset.voter = v.voter_id;

      const name = [v.first_name, v.last_name].filter(Boolean).join(" ");
      const party = v.political_party ? (' â€¢ Party: ' + v.political_party) : '';
      const phone = v.phone_1 ? ('Phone: ' + v.phone_1) : 'Phone: â€”';
      voterInfo.innerHTML =
        `<strong>${name || "â€”"}</strong><br/>${(v.city||'')} ${(v.county||'')}${party}<br/>${phone}`;

      setMsg("");
    }

    let inFlightNext = false;

    async function loadWho() {
      try {
        const j = await apiGet('whoami');
        who.textContent = (j && (j.email || j.user?.email)) ? `Signed in as: ${j.email || j.user.email}` : 'Not signed in';
      } catch (e) {
        who.innerHTML = `<span class="error">Unable to reach API: ${e.message}</span>`;
      }
    }

    async function nextVoter() {
      if (inFlightNext) return;
      inFlightNext = true;
      getNextBtn.disabled = true;
      saveBtn.disabled = true;
      setMsg("Loading next voterâ€¦");

      try {
        const filters = getFilters();
        const exclude_ids = getSeen();
        console.log('ðŸ“‹ Filters:', filters, 'Excluding:', exclude_ids);

        const v = await apiPost('call', { filters, exclude_ids });
        console.log('ðŸ“¨ Received voter data:', v);

        if (!v || v.empty || !v.voter_id) {
          console.warn('âš ï¸ No voter data:', {hasData: !!v, isEmpty: v?.empty, hasVoterId: !!v?.voter_id});
          renderVoter(null);
          return;
        }

        renderVoter(v);
        pushSeen(v.voter_id);
      } catch (e) {
        console.error('âŒ nextVoter error:', e);
        renderVoter(null);
        setMsg(`Error: ${e.message}`, "error");
      } finally {
        inFlightNext = false;
        getNextBtn.disabled = false;
        saveBtn.disabled = false;
      }
    }

    async function saveAndNext() {
      const payload = {
        voter_id: voterCard.dataset.voter || "",
        outcome: document.getElementById("outcome").value,
        ok_callback: +document.getElementById("ok_callback").checked,
        requested_info: +document.getElementById("requested_info").checked,
        dnc: +document.getElementById("dnc").checked,
        best_day: document.getElementById("best_day").value || null,
        best_time_window: document.getElementById("best_time_window").value || null,
        optin_sms: +document.getElementById("optin_sms").checked,
        optin_email: +document.getElementById("optin_email").checked,
        email: document.getElementById("email").value || null,
        wants_volunteer: +document.getElementById("wants_volunteer").checked,
        share_insights_ok: +document.getElementById("share_insights_ok").checked,
        for_term_limits: +document.getElementById("for_term_limits").checked,
        issue_public_lands: +document.getElementById("issue_public_lands").checked,
        comments: document.getElementById("comments").value || null
      };
      if (!payload.voter_id) { alert("No voter selected."); return; }
      if (!payload.outcome) { alert("Choose an outcome."); return; }

      try {
        setMsg("Saving...");
        const saveBody = {
          voter_id: payload.voter_id,
          result: payload.outcome,           // API expects 'result'
          notes: payload.comments || null,
          ok_callback: payload.ok_callback,
          requested_info: payload.requested_info,
          dnc: payload.dnc,
          best_day: payload.best_day || null,
          best_time_window: payload.best_time_window || null,
          optin_sms: payload.optin_sms,
          optin_email: payload.optin_email,
          email: payload.email || null,
          wants_volunteer: payload.wants_volunteer,
          share_insights_ok: payload.share_insights_ok,
          for_term_limits: payload.for_term_limits,
          issue_public_lands: payload.issue_public_lands
        };
        await apiPost('call', saveBody);

        // reset a few fields
        document.getElementById("outcome").value = "";
        document.getElementById("best_day").value = "";
        document.getElementById("best_time_window").value = "";
        document.getElementById("email").value = "";
        document.getElementById("comments").value = "";
        ["ok_callback","requested_info","dnc","optin_sms","optin_email",
         "wants_volunteer","share_insights_ok","for_term_limits","issue_public_lands"]
         .forEach(id => document.getElementById(id).checked = false);

        setMsg("Saved.");
        const vid = voterCard.dataset.voter;
        if (vid) pushSeen(vid);
        nextVoter();
      } catch (e) {
        setMsg(`Save failed: ${e.message}`, "error");
      }
    }

    // Wire events
    getNextBtn.addEventListener("click", nextVoter);
    saveBtn.addEventListener("click", saveAndNext);
    skipBtn.addEventListener("click", () => {
      const vid = voterCard.dataset.voter;
      if (vid) pushSeen(vid);
      nextVoter();
    });
    window.addEventListener("keydown", (e) => {
      if (e.key.toLowerCase() === "n" && !e.metaKey && !e.ctrlKey && !e.altKey) {
        e.preventDefault(); nextVoter();
      }
    });

    // Init
    const filters = getFilters();
    showFiltersBadge(filters);
    console.log("âœ… Ready, loading data...");
    try { await loadWho(); } catch {}
    await nextVoter();
  </script>
  <script>
  // Fallback for non-module or failed ESM import: use browser global
  window.environmentConfig = window.environmentConfig || (window.GrassrootsEnv || {});
  </script>
</body>
</html>
