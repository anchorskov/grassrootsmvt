# GrassrootsMVT UI / Worker Environment Status Report
_Last updated: 2025-10-27_

## Overview
This document summarizes the current environment behavior of the **GrassrootsMVT Volunteer Hub** after restoring the working local snapshot (`docs_combined_review.txt`).  
The restored codebase now **runs successfully on localhost** and **mostly functions on Cloudflare Pages + Workers**.  
It also explains **why previous builds failed** and identifies the few remaining gaps in production.

---

## ‚úÖ Current State: What Works Now

### 1. Unified Environment Detection
**Files involved:**
- `ui/config/environments.js`
- `worker/wrangler.toml`
- `worker/src/index.js`

Both frontend and backend now share a common detection mechanism that differentiates between:
- **Localhost development** (`http://127.0.0.1` / `http://localhost`)
- **Staging** (Cloudflare preview deployments)
- **Production** (`https://volunteers.grassrootsmvt.org`)

Each mode defines consistent values for:
```js
auth: { enabled, bypassAuthentication, testMode }
config: { environment, apiBase, isLocal }

Impact:
Earlier mismatches (frontend detecting ‚Äúlocal‚Äù while backend used production tokens) caused crashes and redirect loops.
The restored version‚Äôs unified detection eliminates these inconsistencies.

2. Local Authentication Bypass

Files involved:

ui/config/environments.js

ui/src/apiClient.js

ui/functions/_utils/verifyAccessJWT.js

worker/src/index.js

Local mode now injects a mock dev user:

{ email: "dev@localhost", name: "Local Developer", isLocal: true }


and bypasses verifyAccessJWT() completely.

Impact:
Local development no longer depends on Cloudflare Access or D1 user tables.
This makes npm run dev immediately functional without external dependencies.

3. API Communication and CORS Handling

Files involved:

worker/wrangler.toml

worker/src/index.js

ALLOW_ORIGIN_DEV is now explicitly set in Wrangler:

ALLOW_ORIGIN_DEV = "http://127.0.0.1:8788,http://localhost:8788"


and parsed dynamically by the Worker, allowing requests from both addresses.

Impact:
Eliminates ‚ÄúCORS policy‚Äù failures that previously blocked local UI ‚Üí Worker communication.

4. Frontend Stability and Fallbacks

Files involved:

ui/index.html

ui/volunteer/index.html

ui/call.html

All main entry pages:

Wait properly for window.__envReady before referencing environment variables.

Display clear UI banners if config loading fails.

Include graceful authentication fallback logic (no infinite redirect loops).

Impact:
The ‚Äú‚ùå FATAL: Environment config object is missing or invalid‚Äù error is now rare and recoverable.

5. Database and Worker Integration

Files involved:

worker/wrangler.toml

instructions/Local_D1_Schema_Snapshot_wy_local_20251026.md

D1 bindings now point to the correct local schema:

[[d1_databases]]
binding = "d1"
database_name = "wy_local"


Impact:
All Worker API routes that depend on D1 tables now execute correctly when testing locally.

6. Error Visibility and Debug Instrumentation

The latest environment loader prints structured logs:

üì° Fetch test for /config/environments.js: HTTP 200
üåç Attempting import: /config/environments.js
‚úÖ Loaded /config/environments.js
üå± Environment config initialized and ready.


Impact:
Diagnosing environment initialization is now straightforward.
You can immediately confirm whether Cloudflare Pages served the correct environments.js file.

‚ö†Ô∏è What Still Does Not Work Perfectly (Cloudflare Remote)
1. /api/whoami Fails Without Session

Symptom:

üîé whoami URL: https://volunteers.grassrootsmvt.org/api/whoami
No resource with given identifier found


Meaning:
The Worker executed successfully but couldn‚Äôt find a valid Cloudflare Access session or database record.

Likely Cause:

Missing or expired Access token cookie (CF_Authorization).

verifyAccessJWT() executing even when bypassAuthentication should apply.

Worker environment variable mis-set (ENVIRONMENT=production even in staging).

2. Access App Misconfiguration

Cloudflare Access variables like:

TEAM_DOMAIN
POLICY_AUD


must be configured for whoami and /auth/finish routes.
If missing, the Worker responds with 404 or ‚ÄúNo resource found.‚Äù

Fix:
Set secrets using:

wrangler secret put TEAM_DOMAIN
wrangler secret put POLICY_AUD

3. Partial Deployment of /config/environments.js

Sometimes Cloudflare Pages doesn‚Äôt copy /ui/config/environments.js to the site root.
If that happens, the import:

await import('/config/environments.js')


returns an HTML 404 response.

Fix:
Ensure your build pipeline copies it explicitly:

cp ui/config/environments.js dist/config/environments.js

4. Worker vs UI Race Conditions (Timing)

Cloudflare modules occasionally execute the UI before the Worker routes are live, causing transient 401/404 responses to /whoami.
This is less common but still possible in production preview deployments.

üßæ Root Cause Summary (Then vs. Now)
Component	Earlier Failing Builds	Current Working Snapshot
Environment Loader	Asynchronous race ‚Üí ‚ÄúFATAL‚Äù invalid config	Uses window.__envReady and import fallback
Frontend Auth	Infinite 401 redirect loops	Guarded re-auth flow with safe bypass
Backend Auth	Always called verifyAccessJWT()	Properly short-circuits in local mode
Wrangler Vars	Missing ENV vars, mismatched D1	Correct ENVIRONMENT=local, wy_local DB
CORS Policy	Rejected localhost origins	Explicitly whitelisted
/whoami route	404 / 401 consistently	Works locally; still flaky remotely
Deployment Assets	/config/environments.js sometimes missing	Build pipeline copies explicitly
UI Startup	Independent modules racing	Synchronized environment load
üîÆ Next Recommended Steps

Cloudflare Secrets Audit

wrangler secret list


Ensure all Access vars are set (TEAM_DOMAIN, POLICY_AUD, etc.)

Verify Deployed Config
Visit:
https://volunteers.grassrootsmvt.org/config/environments.js

Confirm it returns valid JavaScript, not HTML.

Tail Worker Logs

npx wrangler tail --env production


Look for:

‚ÄúBypassing authentication (local mode)‚Äù ‚Üí üü† if seen on production, fix env vars.

‚ÄúNo resource with given identifier found‚Äù ‚Üí missing Access token.

Refactor Build Step
Add to your Pages build:

cp ui/config/environments.js dist/config/environments.js


Optional
Add a diagnostic endpoint /api/envinfo that dumps:

{ environment: "production", authBypass: false, configLoaded: true }


for fast troubleshooting.

üß† Summary

In short:

The restored snapshot succeeds locally because environment detection, authentication bypass, and CORS settings now align.

It ‚Äúmostly works‚Äù remotely because the frontend and backend are correctly configured but Cloudflare Access integration and environment variables still need synchronization.

Once production‚Äôs Worker secrets and /config/environments.js deployment are fully aligned, remote behavior should exactly match local success.

Authored by: Code GPT (Environment Diagnostic Mode)
Date: 2025-10-27
Status: ‚úÖ Local works / ‚ö†Ô∏è Remote partially working